C:\Users\RUCO3670\PycharmProjects\OpenTests\.venv\Scripts\python.exe "C:/Program Files/JetBrains/PyCharm Community Edition 2024.3.2/plugins/python-ce/helpers/pycharm/_jb_pytest_runner.py" --path C:\Users\RUCO3670\PycharmProjects\OpenTests\api_testing_project\tests\flow_tests\offer\test_simulate_to_create_offer_to_full_commerce_new_to_order_crate_flow.py 
Testing started at 14:42 ...
Launching pytest with arguments C:\Users\RUCO3670\PycharmProjects\OpenTests\api_testing_project\tests\flow_tests\offer\test_simulate_to_create_offer_to_full_commerce_new_to_order_crate_flow.py --no-header --no-summary -q in C:\Users\RUCO3670\PycharmProjects\OpenTests\api_testing_project\tests\flow_tests\offer

============================= test session starts =============================
collecting ... collected 5 items

test_simulate_to_create_offer_to_full_commerce_new_to_order_crate_flow.py::TestSimulateOfferUpdateOfferFullOrderE2E::test_full_chain_with_update_offer[Material] 
test_simulate_to_create_offer_to_full_commerce_new_to_order_crate_flow.py::TestSimulateOfferUpdateOfferFullOrderE2E::test_full_chain_with_update_offer[BTP] 
test_simulate_to_create_offer_to_full_commerce_new_to_order_crate_flow.py::TestSimulateOfferUpdateOfferFullOrderE2E::test_full_chain_with_update_offer[CleverHit] 
test_simulate_to_create_offer_to_full_commerce_new_to_order_crate_flow.py::TestSimulateOfferUpdateOfferFullOrderE2E::test_industrial_chain_without_order[Industrial] 
=== Running test for: Material code - full flow with UpdateOffer ===
SIMULATE RESPONSE
{'objects': [{'orderLines': [{'bomLines': [], 'schedules': [{'lineNumber': 1, 'confirmedQuantity': 25, 'correctedQuantity': 25, 'orderedQuantity': 25, 'deliveryDate': None, 'correctedDeliveryDate': None, 'scheduleType': 'Unavailable'}], 'odid': None, 'copiedFromId': None, 'lineNumber': 1, 'hasPromo': True, 'sourceLineNumber': 1, 'materialCode': '003L0144R', 'altMaterialCode': '003L0144R', 'description': 'LV Ду 15 Клапан запорный прямой никелированный', 'descriptionExtended': None, 'salesPrice': 1652.55, 'warrantyPrice': 0, 'width': 0, 'weight': 0.211, 'orderedQuantity': 25, 'availableQuantity': 0, 'transitQuantity': 0, 'confirmedDeliveryDate': None, 'deliveryTimeStandard': '7 недель', 'surchargesPrice': 21483.15, 'surchargesPercent': 0.0, 'tax': 4296.63, 'discount': 0, 'discountPercent': 48.0, 'corridorCooficient': None, 'clientDiscountPercent': 0, 'distrDiscountPercent': 48.0, 'distrContractDiscount': 48.0, 'distrMaxDiscount': 0, 'approvedDiscount': None, 'currency': 'RUB', 'cost': 0, 'costCurrency': 'RUB', 'salesPriceWithTax': 25779.78, 'comments': [{'comment': '', 'color': None}], 'category': None, 'statuses': [{'code': 3, 'description': 'Специальное правило расчёта. Применён курс 115 руб., при расчёте стоимости по прайсу.'}], 'lineType': 'Material', 'mpg': '1D', 'areaActivity': {'id': 'aff0fafb-0e4e-11ed-9528-5254008cf63f', 'description': 'Теплоавтоматика РФ'}, 'gfu': None, 'materialSubType': 'Ридан', 'availability': {'requestedQty': 25, 'onStockQty': 0, 'transit': None, 'onTransitQty': 0, 'transitDate': None, 'notAvailableQty': 25, 'deliveryWeeks': 0, 'deliveryDays': None, 'deliveryTimeStandard': '7 недель'}, 'isSpecialPrice': False, 'isCorrectedQuantity': False, 'allowCreateDueDeliveryTicket': True, 'isZeroPrices': False, 'lockCode': None, 'isManufactureReserved': False, 'equipmentCategoryId': 'ad074dda-20dd-437a-b86e-2980817e52a3', 'equipmentCategory': 'Запорные боковые радиаторные клапаны', 'packageSize': 1, 'promoCurrencyValue': 115.0, 'autoDistrPosDiscount': 0, 'autoClientPosDiscount': 0, 'excludePosition': False, 'sourcePrice': {'value': 14.37, 'convertedOfferValue': 14.37, 'valueQty': None, 'convertedOfferValueQty': None, 'qty': None, 'currency': 'CU'}, 'specialPrice': None, 'tenderAmount': None, 'calc': None}], 'orderParty': {'currency': 'RUB', 'customerGroup': None, 'debtorAccount': 'RT25-7705238125-HE', 'deliveryAddress': None, 'deliveryMode': None, 'deliveryPlant': None, 'paymentTerms': 'RU00', 'salesGroup': '', 'salesOffice': '', 'exchangeRate': 98.1888, 'deliveryModeText': None, 'deliveryPlantName': None, 'salesOfficeText': '', 'salesGroupText': '', 'paymentTermsText': '', 'currencyDate': '2025-11-06T00:00:00+03:00', 'exchangeRateType': 'YRU'}, 'deliveryReceivers': [], 'itPtips': None, 'discountTips': None, 'discountTip': None, 'volumeDiscountTips': None, 'kitDiscountTips': None, 'authoPriceResults': None, 'sourceTenderOffer': None}], 'status': 'Ok', 'messages': []}
Исходное количество из Simulate: 25
Order lines from Simulate: [{'materialCode': '003L0144R', 'quantity': 25, 'lineNumber': 1, 'lineType': 'Material', 'odid': None}]

================================================================================
CREATE OFFER PAYLOAD (что отправляем):
{'source': 'CRM', 'currency': 'RUB', 'exchangeRateType': 'CBR', 'debtorAccount': 'RT25-7705238125-HE', 'personId': '920bb836-8ee4-4571-b5bd-94bd28c29d32', 'paymentTerms': 'RU00', 'deliveryOptions': {'consigneeId': '00000000-0000-0000-0000-000000000000'}, 'orderLines': [{'materialCode': '003L0144R', 'quantity': 25, 'lineNumber': 1, 'lineType': 'Material', 'odid': None}], 'isDraft': True, 'userComment': 'ТЕСТ флоу методов Material - CreateOffer'}
================================================================================

CREATE OFFER RESPONSE
{'objects': [{'lines': [{'remark': None, 'avaliability': [], 'bomSet': None, 'salesPrice': 698.77, 'cost': None, 'costCurrency': None, 'quantity': 25, 'description': 'LV Ду 15 Клапан запорный прямой никелированный', 'code': '003L0144R', 'altMaterialCode': None, 'totalWithDiscountSurchargesAndVAT': 20962.968, 'totalWithDiscountAndSurcharges': None, 'totalWithDiscount': None, 'surchargesDelayPercent': None, 'surchargesCurrencyConversionPercent': None, 'discountAmount': None, 'discountPercent': 48.0, 'weight': None, 'deliveryWeeks': 0, 'calcNumber': None, 'calculationComment': None, 'comment': None, 'isSpecial': 0, 'isProtected': False, 'calcId': None, 'hexIsReady': False, 'clientDiscountPercent': None, 'clientBroughtAmountResult': None, 'itpDiscountPercent': None, 'contractDiscountPercent': None, 'sourceNOrder': 1, 'positionOrder': 1, 'warrantyTotal': None, 'salesPriceWithoutDiscount': 1343.78, 'totalWithoutDiscount': 33594.5, 'subType': 'Import', 'mpg': None, 'prodHierarchy': None, 'category': None, 'taxes': 0, 'abcCategory': None, 'equipmentCategoryId': None, 'equipmentCategory': None, 'surchargePercent': 0}], 'offers': [{'sapReferenceNumber': None, 'paymentTerms': None, 'exchangeRate': 0, 'deliveryPlant': None, 'deliveryMode': None, 'deliveryAddress': None, 'debtorAccount': None, 'currency': 'RUB', 'broughtAmountResult': 20962.9675, 'number': 'PQ04776933', 'id': '1d536639-12e3-4bc4-46be-08de1d00de21', 'isITPsuccess': None, 'crmUrl': None, 'clientBroughtAmountResult': 0, 'pObjectName': None, 'pObjectNumber': None, 'specificationNumber': None, 'opportunityName': None}], 'invoices': None, 'errors': None, 'itPtips': None, 'createdOffers': None}], 'status': 'Ok', 'messages': []}
Created offer_id: 1d536639-12e3-4bc4-46be-08de1d00de21, offer_number: PQ04776933
URL FullCommerceNew - https://ruecom-intru-tst.ridancorp.net/dapi/api/CrmCommerce/FullCommerceNew?requestId=1d536639-12e3-4bc4-46be-08de1d00de21
FULL COMMERCE NEW RESPONSE (до UpdateOffer)
{'objects': [{'data': [{'delayedDeliveryDiscountValue': 0.0, 'purchaseType': {'allowPartial': True, 'id': '121b015a-e76d-4688-9bb6-2a56ec6de2ef', 'value': 'Частичная закупка'}, 'paymentSchedule': None, 'completeDeliveryFrom': None, 'paidStorages': None, 'payPercentBeforePlacingIntoProduction': 100, 'filesPO': [], 'filesSA5': [], 'filesSA': [], 'files': [], 'termDate': None, 'sapAuthorPersonNumber': None, 'sapCodeDelivery': None, 'crmPassportNumber': None, 'passportId': None, 'passportResponsiblePhone': '+7 (987) 400-63-80', 'passportResponsibleName': 'Семенов Даниил', 'passportResponsibleEmail': 'Ruco1080@ridan.ru', 'passportResponsibleNumber': '00001080', 'endClientOrderInitiator': None, 'specificationTitle': None, 'markupPercentResult': None, 'markupResult': 0.0, 'euroRateOffer': 93.5131, 'clientBroughtAmountResult': 40313.4, 'currencyDate': '2025-11-06T00:00:00', 'syncDate': None, 'currency': 'RUB', 'vaTcoef': 1.2, 'vaTperc': 20, 'isEndUserPQ': False, 'vaTresult': 3493.828, 'totalVat': 20962.9675, 'total': 17469.139583333334, 'validDate': '2025-11-20T14:42:22.197', 'validDays': 14, 'totalDistrDiscountPrice': 20962.9675, 'salesPrice': 33594.5, 'objectCity': None, 'objectAddress': None, 'objectNumber': None, 'objectName': 'Стандартный заказ 11.2025', 'orders': None, 'debtorAccount': 'RT25-7705238125-HE', 'payerDisplay': 'фирма "ВОДОКОМФОРТ" (Офис Москва)', 'payerId': 'acb8f425-c3b6-4b38-9f34-1e7fbfd53fa9', 'paymentTerm': {'code': 'RU00', 'text': 'Предоплата', 'creditDays': 0, 'prepayPercent': 100}, 'endUserClientPerson': None, 'endUserClientId': None, 'endUserClient': None, 'createDate': '2025-11-06T14:42:22.197', 'commerceNumber': 'PQ04776933', 'deliveryShortInfo': 'Доставка, со склада в дер. Лешково, Истринский р-на (Московская обл.)  до  (Доставка до терминала, Бесплатно)', 'deliveryCondition': None, 'statusDisplay': 'Черновик', 'status': '5d6f1a5d-3254-44e5-97d7-c4d20f440b61', 'surchargesPayment': 0.0, 'surchargesConvertation': 0.0, 'partialPurchase': True, 'crmCommerceId': '1d536639-12e3-4bc4-46be-08de1d00de21', 'salesOffice': 'Москва', 'finalClientInn': None, 'payerInn': '7705238125', 'deliveryOptions': {'consigneeCode': None, 'condition': None, 'mode': None, 'deliveryType': 'Contract', 'materialType': 'regularCodesMSK', 'deliveryCost': 0, 'deliveryCostInOrderCurrency': 0, 'totalDeliveryWeight': 5.275, 'comment': None, 'consigneeAgreementDelivery': None, 'clientFinalDelivery': None, 'consigneeContacts': None, 'endPoint': None, 'desiredDeliveryDate': None, 'deliverFullSetOnly': False, 'costIncludedInOrder': False, 'consigneeId': '00000000-0000-0000-0000-000000000000'}, 'deliveryOptionsHex': None, 'deliveryOptionsProd': None, 'deliveryOptionsDZRProd': None, 'availableForDistributor': False, 'isOrder': False, 'isValid': True, 'isITPsuccess': False, 'creatorUserId': 'c7b44ced-3896-4f25-a170-3349f18d0524', 'creatorPersonId': '920bb836-8ee4-4571-b5bd-94bd28c29d32', 'creatorDisplay': 'Тест НЕ_РАЗМЕЩАТЬ_НИЧЕГО', 'orderNumber': None, 'sapReferenceNumber': None, 'approvementDeclined': False, 'distrApprovement': None, 'endClientOrderCreator': {'personId': '920bb836-8ee4-4571-b5bd-94bd28c29d32', 'email': 'k.tertyshnyi@vodokomfort.ru', 'phone': '+7 (906) 034-13-83', 'name': 'фирма "ВОДОКОМФОРТ" (Офис Москва)'}, 'autoDistrDiscount': None, 'autoFromEngSpec': False, 'finalBayerId': None, 'factPaymentPercent': 0.0, 'extendedWarranty': {'type': 'None', 'paymentType': 'None', 'invoiceType': 'None'}, 'isPinnedFinalBuyer': False, 'reservationEnd': None, 'autoClientDiscount': None, 'comments': [{'comment': 'ТЕСТ флоу методов Material - CreateOffer', 'author': 'Тертышный К.', 'createDate': '2025-11-06T14:42:22.197'}], 'endUserPQStatusId': None, 'endUserPQDescription': None, 'confirmTimeByDistr': None, 'responseTimeClient': None, 'opportunityId': '383d6790-574d-4d14-ae30-7ea1458a94b4', 'finalBuyerCDLId': None, 'offerType': 'PQ', 'offerFlags': [], 'showPriceWithDiscount': False, 'showDiscount': True, 'source': 'CRM', 'oneCCurrentStatus': None, 'clientPersonId': None, 'deliveryTerms': None, 'deliveryTermsPTO': None}], 'details': [{'fromMoscow': False, 'weight': 0.211, 'packageSize': 1, 'ptoReadyForShipmentValue': 49, 'islBox': False, 'isBTP': False, 'isPTO': False, 'isTDU': False, 'lineType': 'Material', 'markupPercentResult': 0.0, 'markupResult': None, 'priceGroup': '1D', 'totalVAT': 20962.9675, 'total': 17469.14, 'vaTresult': 3493.828, 'retailPriceResultNoNDS': 33594.5, 'retailPriceResult': 40313.4, 'discount': 48.0, 'currency': 'RUB', 'salesPrice': 1343.78, 'clientSalesPrice': 1343.78, 'text': 'LV Ду 15 Клапан запорный прямой никелированный', 'code': '003L0144R', 'materialCode': '003L0144R', 'qty': 25.0, 'id': '6f6687c3-a240-46fa-a9cd-bbfb5d056ba5', 'item': 1, 'hexNumber': None, 'btpNumber': None, 'warrantyTotal': 0.0, 'clientDiscountPercent': None, 'clientBroughtAmountResult': 40313.4, 'availableForOrder': 25.0, 'deliveredCount': 0, 'stockCount': 0, 'packagedCount': 0, 'notPayedCount': 0, 'transit': None, 'isCanceled': False, 'canceledQuantity': 0, 'cancelReason': None, 'isSpecialPrice': False, 'bomSet': None, 'organization': {'contractorId': '20c340fe-6aff-486f-b248-fd8dbe2c93cd', 'inn': '5017132318', 'contractorName': 'ООО "РИДАН ТРЕЙД"', 'approvers': []}, 'shippedAt': None, 'applyedPromo': None, 'invoiceNumber': None, 'invoiceDate': None, 'warehouse': None, 'isExclusiveBTP': False}], 'permissions': {'edit': False, 'moveToDraft': False, 'delete': False, 'addComment': False, 'addFile': False, 'getFile': False}}], 'status': 'Ok', 'messages': []}
Найдено 1 позиций в details
Mapping: 003L0144R → 6f6687c3-a240-46fa-a9cd-bbfb5d056ba5
Contractor: 003L0144R → 20c340fe-6aff-486f-b248-fd8dbe2c93cd
✓ Updated ODID for 003L0144R: 6f6687c3-a240-46fa-a9cd-bbfb5d056ba5
✓ Updated contractorId for 003L0144R: 20c340fe-6aff-486f-b248-fd8dbe2c93cd
Updated order lines with ODID: [{'materialCode': '003L0144R', 'quantity': 25, 'lineNumber': 1, 'lineType': 'Material', 'odid': '6f6687c3-a240-46fa-a9cd-bbfb5d056ba5', 'contractorId': '20c340fe-6aff-486f-b248-fd8dbe2c93cd'}]

  Ожидаем lineType: 'Material'
  Получили lineType: 'Material'
  lineType корректен: 'Material'

================================================================================
ПРОВЕРКА СТАНДАРТНЫХ ПОЛЕЙ ПОСЛЕ CreateOffer → FullCommerceNew
================================================================================

 materialCode: ожидаем '003L0144R', получили '003L0144R'
 quantity: ожидаем 25, получили 25.0
 currency: ожидаем 'RUB', получили 'RUB'
 debtorAccount: ожидаем 'RT25-7705238125-HE', получили 'RT25-7705238125-HE'
 personId: ожидаем '920bb836-8ee4-4571-b5bd-94bd28c29d32', получили '920bb836-8ee4-4571-b5bd-94bd28c29d32'

 Все стандартные поля корректны!
================================================================================

Original Seller ID: 20c340fe-6aff-486f-b248-fd8dbe2c93cd
Original Contractor Name: ООО "РИДАН ТРЕЙД"
OpportunityId из FullCommerceNew: 383d6790-574d-4d14-ae30-7ea1458a94b4

================================================================================
UPDATE OFFER PAYLOAD (что отправляем):
{'source': 'CRM', 'currency': 'RUB', 'exchangeRateType': 'CBR', 'debtorAccount': 'RT25-7705238125-HE', 'personId': '920bb836-8ee4-4571-b5bd-94bd28c29d32', 'paymentTerms': 'RU00', 'offerId': '1d536639-12e3-4bc4-46be-08de1d00de21', 'opportunityId': '383d6790-574d-4d14-ae30-7ea1458a94b4', 'orderLines': [{'materialCode': '003L0144R', 'quantity': 30, 'lineNumber': 1, 'lineType': 'Material', 'odid': '6f6687c3-a240-46fa-a9cd-bbfb5d056ba5', 'contractorId': '20c340fe-6aff-486f-b248-fd8dbe2c93cd', 'discountPercent': 10, 'endClientDiscountPercent': 10}], 'deliveryOptions': {'consigneeId': '00000000-0000-0000-0000-000000000000'}, 'isDraft': False, 'userComment': 'ТЕСТ флоу методов - UpdateOffer'}
================================================================================

UPDATE OFFER RESPONSE
{'objects': [{'status': True}], 'status': 'Ok', 'messages': []}
✓ UpdateOffer успешно выполнен!
URL FullCommerceNew - https://ruecom-intru-tst.ridancorp.net/dapi/api/CrmCommerce/FullCommerceNew?requestId=1d536639-12e3-4bc4-46be-08de1d00de21
FULL COMMERCE NEW RESPONSE (после UpdateOffer)
{'objects': [{'data': [{'delayedDeliveryDiscountValue': 0.0, 'purchaseType': {'allowPartial': True, 'id': '121b015a-e76d-4688-9bb6-2a56ec6de2ef', 'value': 'Частичная закупка'}, 'paymentSchedule': None, 'completeDeliveryFrom': None, 'paidStorages': None, 'payPercentBeforePlacingIntoProduction': 100, 'filesPO': [], 'filesSA5': [], 'filesSA': [], 'files': [], 'termDate': '2025-11-20T23:59:59', 'sapAuthorPersonNumber': None, 'sapCodeDelivery': None, 'crmPassportNumber': None, 'passportId': None, 'passportResponsiblePhone': '+7 (987) 400-63-80', 'passportResponsibleName': 'Семенов Даниил', 'passportResponsibleEmail': 'Ruco1080@ridan.ru', 'passportResponsibleNumber': '00001080', 'endClientOrderInitiator': None, 'specificationTitle': None, 'markupPercentResult': None, 'markupResult': 0.0, 'euroRateOffer': 93.5131, 'clientBroughtAmountResult': 43538.4, 'currencyDate': '2025-11-06T00:00:00', 'syncDate': None, 'currency': 'RUB', 'vaTcoef': 1.2, 'vaTperc': 20, 'isEndUserPQ': False, 'vaTresult': 7256.412, 'totalVat': 43538.472, 'total': 36282.06, 'validDate': '2025-11-20T14:42:23.57', 'validDays': 14, 'totalDistrDiscountPrice': 43538.472, 'salesPrice': 40313.4, 'objectCity': None, 'objectAddress': None, 'objectNumber': None, 'objectName': 'Стандартный заказ 11.2025', 'orders': None, 'debtorAccount': 'RT25-7705238125-HE', 'payerDisplay': 'фирма "ВОДОКОМФОРТ" (Офис Москва)', 'payerId': 'acb8f425-c3b6-4b38-9f34-1e7fbfd53fa9', 'paymentTerm': {'code': 'RU00', 'text': 'Предоплата', 'creditDays': 0, 'prepayPercent': 100}, 'endUserClientPerson': None, 'endUserClientId': None, 'endUserClient': None, 'createDate': '2025-11-06T14:42:22.197', 'commerceNumber': 'PQ04776933', 'deliveryShortInfo': 'Доставка, со склада в дер. Лешково, Истринский р-на (Московская обл.)  до  (Доставка до терминала, Бесплатно)', 'deliveryCondition': None, 'statusDisplay': 'Готов', 'status': '68c12a88-973a-4f7f-88aa-4242a1f81f40', 'surchargesPayment': 0.0, 'surchargesConvertation': 0.0, 'partialPurchase': True, 'crmCommerceId': '1d536639-12e3-4bc4-46be-08de1d00de21', 'salesOffice': 'Москва', 'finalClientInn': None, 'payerInn': '7705238125', 'deliveryOptions': {'consigneeCode': None, 'condition': None, 'mode': None, 'deliveryType': 'Contract', 'materialType': 'regularCodesMSK', 'deliveryCost': 0, 'deliveryCostInOrderCurrency': 0, 'totalDeliveryWeight': 6.33, 'comment': None, 'consigneeAgreementDelivery': None, 'clientFinalDelivery': None, 'consigneeContacts': None, 'endPoint': None, 'desiredDeliveryDate': None, 'deliverFullSetOnly': False, 'costIncludedInOrder': False, 'consigneeId': '00000000-0000-0000-0000-000000000000'}, 'deliveryOptionsHex': None, 'deliveryOptionsProd': None, 'deliveryOptionsDZRProd': None, 'availableForDistributor': True, 'isOrder': False, 'isValid': True, 'isITPsuccess': False, 'creatorUserId': 'c7b44ced-3896-4f25-a170-3349f18d0524', 'creatorPersonId': '920bb836-8ee4-4571-b5bd-94bd28c29d32', 'creatorDisplay': 'Тест НЕ_РАЗМЕЩАТЬ_НИЧЕГО', 'orderNumber': None, 'sapReferenceNumber': None, 'approvementDeclined': False, 'distrApprovement': None, 'endClientOrderCreator': {'personId': '920bb836-8ee4-4571-b5bd-94bd28c29d32', 'email': 'k.tertyshnyi@vodokomfort.ru', 'phone': '+7 (906) 034-13-83', 'name': 'фирма "ВОДОКОМФОРТ" (Офис Москва)'}, 'autoDistrDiscount': None, 'autoFromEngSpec': False, 'finalBayerId': None, 'factPaymentPercent': 0.0, 'extendedWarranty': {'type': 'None', 'paymentType': 'None', 'invoiceType': 'None'}, 'isPinnedFinalBuyer': False, 'reservationEnd': None, 'autoClientDiscount': None, 'comments': [{'comment': 'ТЕСТ флоу методов Material - CreateOffer', 'author': 'Тертышный К.', 'createDate': '2025-11-06T14:42:22.197'}, {'comment': 'ТЕСТ флоу методов - UpdateOffer', 'author': 'Тертышный К.', 'createDate': '2025-11-06T14:42:23.37'}], 'endUserPQStatusId': None, 'endUserPQDescription': None, 'confirmTimeByDistr': None, 'responseTimeClient': None, 'opportunityId': '383d6790-574d-4d14-ae30-7ea1458a94b4', 'finalBuyerCDLId': None, 'offerType': 'PQ', 'offerFlags': [], 'showPriceWithDiscount': False, 'showDiscount': True, 'source': 'CRM', 'oneCCurrentStatus': None, 'clientPersonId': None, 'deliveryTerms': None, 'deliveryTermsPTO': None}], 'details': [{'fromMoscow': False, 'weight': 0.211, 'packageSize': 1, 'ptoReadyForShipmentValue': 49, 'islBox': False, 'isBTP': False, 'isPTO': False, 'isTDU': False, 'lineType': 'Material', 'markupPercentResult': 0.0, 'markupResult': None, 'priceGroup': '1D', 'totalVAT': 43538.472, 'total': 36282.06, 'vaTresult': 7256.412, 'retailPriceResultNoNDS': 40313.4, 'retailPriceResult': 48376.08, 'discount': 10.0, 'currency': 'RUB', 'salesPrice': 1343.78, 'clientSalesPrice': 1343.78, 'text': 'LV Ду 15 Клапан запорный прямой никелированный', 'code': '003L0144R', 'materialCode': '003L0144R', 'qty': 30.0, 'id': '6f6687c3-a240-46fa-a9cd-bbfb5d056ba5', 'item': 1, 'hexNumber': None, 'btpNumber': None, 'warrantyTotal': 0.0, 'clientDiscountPercent': 10.0, 'clientBroughtAmountResult': 43538.4, 'availableForOrder': 30.0, 'deliveredCount': 0, 'stockCount': 0, 'packagedCount': 0, 'notPayedCount': 0, 'transit': None, 'isCanceled': False, 'canceledQuantity': 0, 'cancelReason': None, 'isSpecialPrice': False, 'bomSet': None, 'organization': {'contractorId': '20c340fe-6aff-486f-b248-fd8dbe2c93cd', 'inn': '5017132318', 'contractorName': 'ООО "РИДАН ТРЕЙД"', 'approvers': []}, 'shippedAt': None, 'applyedPromo': None, 'invoiceNumber': None, 'invoiceDate': None, 'warehouse': None, 'isExclusiveBTP': False}], 'permissions': {'edit': False, 'moveToDraft': False, 'delete': False, 'addComment': False, 'addFile': False, 'getFile': False}}], 'status': 'Ok', 'messages': []}

Проверка количества для 003L0144R:
  Ожидаем: 30
  Получили: 30.0
✓ Количество корректно!

Проверка скидки для 003L0144R:
  Ожидаем: 10%
  Получили: 10.0%
✓ Скидка корректна!

================================================================================
ПРОВЕРКА ПОЛЕЙ ПОСЛЕ UpdateOffer → FullCommerceNew
================================================================================

 materialCode: ожидаем '003L0144R', получили '003L0144R'
 quantity: ожидаем 30, получили 30.0
 discount: ожидаем 10%, получили 10.0%
 currency: ожидаем 'RUB', получили 'RUB'
 debtorAccount: ожидаем 'RT25-7705238125-HE', получили 'RT25-7705238125-HE'
 personId: ожидаем '920bb836-8ee4-4571-b5bd-94bd28c29d32', получили '920bb836-8ee4-4571-b5bd-94bd28c29d32'
 lineType: ожидаем 'Material', получили 'Material'

 Все поля после UpdateOffer корректны!
================================================================================

✓ Все изменения успешно применились!
Найдено 1 позиций в details
Mapping: 003L0144R → 6f6687c3-a240-46fa-a9cd-bbfb5d056ba5
Contractor: 003L0144R → 20c340fe-6aff-486f-b248-fd8dbe2c93cd
✓ Updated ODID for 003L0144R: 6f6687c3-a240-46fa-a9cd-bbfb5d056ba5
✓ Updated contractorId for 003L0144R: 20c340fe-6aff-486f-b248-fd8dbe2c93cd
ORDER CREATE PAYLOAD
{'orderLines': [{'materialCode': '003L0144R', 'quantity': 30, 'lineNumber': 1, 'lineType': 'Material', 'odid': '6f6687c3-a240-46fa-a9cd-bbfb5d056ba5', 'contractorId': '20c340fe-6aff-486f-b248-fd8dbe2c93cd', 'discountPercent': 10, 'endClientDiscountPercent': 10}], 'isEndUserPQ': False, 'docType': 'Quotation', 'authorNumber': '0000612383', 'currencyDate': None, 'exchangeRateType': None, 'projectDiscountConditions': False, 'debtorAccount': 'RT25-7705238125-HE', 'finalBuyerCDLId': None, 'clientInn': None, 'userComment': 'ТЕСТ флоу методов - Order/Create', 'engineerComment': '', 'currency': 'RUB', 'methodCode': 'ZWEB', 'purchaseDate': '2024-09-27T12:18:27+03:00', 'delayedDeliveryDiscountValue': None, 'personId': '920bb836-8ee4-4571-b5bd-94bd28c29d32', 'offerId': '1d536639-12e3-4bc4-46be-08de1d00de21', 'passportId': None, 'opportunityId': None, 'specTypeId': None, 'specificationId': None, 'salesGroup': 'RU1', 'salesOffice': 'RU01', 'referenceNumber': 'Z0000052452', 'paymentTerms': 'RU00', 'isDraft': False, 'purchaseType': None, 'finalBuyerId': None, 'availableForDistributor': False, 'autoAvailableForDistributor': None, 'payPercentComponentsBTP': None, 'payPercentBeforePlacingIntoProduction': None, 'customerId': None, 'isCLHOffer': False, 'deliveryOptions': {'consigneeCode': None, 'condition': 'RU', 'mode': 16, 'deliveryCost': 0, 'totalDeliveryWeight': 20.889, 'comment': '', 'consigneeAgreementDelivery': None, 'clientFinalDelivery': None, 'consigneeContacts': None, 'endPoint': 'ToDoor', 'desiredDeliveryDate': '2024-09-30T12:18:27+03:00', 'deliverFullSetOnly': False, 'costIncludedInOrder': False, 'consigneeId': '00000000-0000-0000-0000-000000000000', 'deliveryType': 'Pickup'}, 'deliveryOptionsHex': None, 'deliveryOptionsProd': None, 'deliveryOptionsDZRProd': None, 'deliveryNotificationSettings': None, 'projectObject': None, 'setContractDiscounts': False, 'currencySpecialFixation': False, 'extendValidit': 0, 'showPriceWithDiscount': False, 'showDiscount': False, 'finalMarkup': None, 'surchargesPayment': None, 'surchargesConversion': None, 'recommendedDistributors': []}
ORDER CREATE RESPONSE
{'objects': [{'id': '20199b0a-ce54-494b-46bf-08de1d00de21', 'docNumber': 'PQ04776933', 'referenceNumber': None, 'hexReferenceNumbers': [], 'offer': {'offerId': '1d536639-12e3-4bc4-46be-08de1d00de21', 'offerNumber': 'PQ04776933'}, 'orders': [{'orderNumber': None, 'orderType': 'Common', 'offerId': '20199b0a-ce54-494b-46bf-08de1d00de21', 'offerNumber': 'PQ04776933-1'}]}], 'status': 'Ok', 'messages': []}
Тест успешно выполнен! Весь цикл с UpdateOffer завершен.
PASSED
=== Running test for: BTP code - full flow with UpdateOffer ===
SIMULATE RESPONSE
{'objects': [{'orderLines': [{'bomLines': [], 'schedules': [{'lineNumber': 0, 'confirmedQuantity': 2, 'correctedQuantity': 2, 'orderedQuantity': 2, 'deliveryDate': None, 'correctedDeliveryDate': None, 'scheduleType': 'Unavailable'}], 'odid': None, 'copiedFromId': None, 'lineNumber': 0, 'hasPromo': True, 'sourceLineNumber': 0, 'materialCode': 'N2202248348-1', 'altMaterialCode': 'N2202248348-1', 'description': 'УВ_Тепловой пункт_N2202248348-1_Тест Шильдика_UV', 'descriptionExtended': None, 'salesPrice': 800495.83, 'warrantyPrice': 0, 'width': 0, 'weight': 521.79, 'orderedQuantity': 2, 'availableQuantity': 0, 'transitQuantity': 0, 'confirmedDeliveryDate': None, 'deliveryTimeStandard': '0 недели', 'surchargesPrice': 1120694.162, 'surchargesPercent': 0.0, 'tax': 224138.8324, 'discount': 0, 'discountPercent': 30.0, 'corridorCooficient': None, 'clientDiscountPercent': 0, 'distrDiscountPercent': 30.0, 'distrContractDiscount': 30.0, 'distrMaxDiscount': 0, 'approvedDiscount': None, 'currency': 'RUB', 'cost': 0, 'costCurrency': 'RUB', 'salesPriceWithTax': 1344832.9944, 'comments': [], 'category': None, 'statuses': [{'code': 3, 'description': 'Специальное правило расчёта. Применён курс 115 руб., при расчёте стоимости по прайсу.'}], 'lineType': 'BTP', 'mpg': '80', 'areaActivity': None, 'gfu': None, 'materialSubType': None, 'availability': {'requestedQty': 2, 'onStockQty': 0, 'transit': None, 'onTransitQty': 0, 'transitDate': None, 'notAvailableQty': 2, 'deliveryWeeks': 0, 'deliveryDays': 0, 'deliveryTimeStandard': '0 рабочих дня'}, 'isSpecialPrice': False, 'isCorrectedQuantity': False, 'allowCreateDueDeliveryTicket': True, 'isZeroPrices': False, 'lockCode': None, 'isManufactureReserved': False, 'equipmentCategoryId': '6f7641c4-616a-42d7-bd70-79dd12f9c686', 'equipmentCategory': 'Блочные Тепловые Пункты', 'packageSize': 0, 'promoCurrencyValue': 115.0, 'autoDistrPosDiscount': 0, 'autoClientPosDiscount': 0, 'excludePosition': False, 'sourcePrice': None, 'specialPrice': None, 'tenderAmount': None, 'calc': {'id': '81351fc2-304b-444e-082f-08ddfc1922ad', 'number': 'N2202248348-1', 'materialCode': None, 'calcType': 'BTP', 'assembleTimeCost': None}}], 'orderParty': {'currency': 'RUB', 'customerGroup': None, 'debtorAccount': 'RT25-7705238125-HE', 'deliveryAddress': None, 'deliveryMode': None, 'deliveryPlant': None, 'paymentTerms': 'RU00', 'salesGroup': '', 'salesOffice': '', 'exchangeRate': 98.1888, 'deliveryModeText': None, 'deliveryPlantName': None, 'salesOfficeText': '', 'salesGroupText': '', 'paymentTermsText': '', 'currencyDate': '2025-11-06T00:00:00+03:00', 'exchangeRateType': 'YRU'}, 'deliveryReceivers': [], 'itPtips': None, 'discountTips': None, 'discountTip': None, 'volumeDiscountTips': None, 'kitDiscountTips': None, 'authoPriceResults': None, 'sourceTenderOffer': None}], 'status': 'Ok', 'messages': []}
Исходное количество из Simulate: 2
Order lines from Simulate: [{'materialCode': 'N2202248348-1', 'quantity': 2, 'lineNumber': 0, 'lineType': 'BTP', 'odid': None}]

================================================================================
CREATE OFFER PAYLOAD (что отправляем):
{'source': 'CRM', 'currency': 'RUB', 'exchangeRateType': 'YRU', 'debtorAccount': 'RT25-7705238125-HE', 'personId': '1c26afd2-1d97-4b7f-92fb-dd21ed412eea', 'paymentTerms': 'RU00', 'orderLines': [{'materialCode': 'N2202248348-1', 'quantity': 2, 'lineNumber': 0, 'lineType': 'BTP', 'odid': None}], 'isDraft': True, 'deliveryOptionsProd': {'consigneeId': '00000000-0000-0000-0000-000000000000'}, 'passportId': '4DBB2A44-D895-468D-A51F-AE98B9B3D487', 'specTypeId': '02061701-51E6-402E-B18F-7BAE7A27F6FB', 'specificationId': '29CDC69A-1CBA-47CF-9F93-8DECBDAF3D9A', 'purchaseType': 'C8EC0EE8-FB5D-4AE1-A664-B2C46A914E46', 'finalBuyerId': 'daa47b0f-8c66-42f9-a5df-44fae4ff18e8', 'customerId': 'acb8f425-c3b6-4b38-9f34-1e7fbfd53fa9', 'currencySpecialFixation': True, 'setContractDiscounts': True, 'userComment': 'ТЕСТ флоу методов BTP - CreateOffer'}
================================================================================

CREATE OFFER RESPONSE
{'objects': [{'lines': [{'remark': None, 'avaliability': [], 'bomSet': None, 'salesPrice': 560347.08, 'cost': None, 'costCurrency': None, 'quantity': 2, 'description': 'УВ_Тепловой пункт_N2202248348-1_Тест Шильдика_UV', 'code': 'N2202248348-1', 'altMaterialCode': None, 'totalWithDiscountSurchargesAndVAT': 1344832.9944, 'totalWithDiscountAndSurcharges': None, 'totalWithDiscount': None, 'surchargesDelayPercent': None, 'surchargesCurrencyConversionPercent': None, 'discountAmount': None, 'discountPercent': 30.0, 'weight': None, 'deliveryWeeks': 0, 'calcNumber': None, 'calculationComment': None, 'comment': None, 'isSpecial': 0, 'isProtected': False, 'calcId': None, 'hexIsReady': False, 'clientDiscountPercent': None, 'clientBroughtAmountResult': None, 'itpDiscountPercent': None, 'contractDiscountPercent': None, 'sourceNOrder': 0, 'positionOrder': 0, 'warrantyTotal': None, 'salesPriceWithoutDiscount': 800495.83, 'totalWithoutDiscount': 1600991.66, 'subType': 'Import', 'mpg': None, 'prodHierarchy': None, 'category': None, 'taxes': 0, 'abcCategory': None, 'equipmentCategoryId': None, 'equipmentCategory': None, 'surchargePercent': 0}], 'offers': [{'sapReferenceNumber': None, 'paymentTerms': None, 'exchangeRate': 0, 'deliveryPlant': None, 'deliveryMode': None, 'deliveryAddress': None, 'debtorAccount': None, 'currency': 'RUB', 'broughtAmountResult': 1344833.0, 'number': 'BTP04776934', 'id': 'ee92c38f-807b-4d72-46c0-08de1d00de21', 'isITPsuccess': None, 'crmUrl': None, 'clientBroughtAmountResult': 0, 'pObjectName': None, 'pObjectNumber': None, 'specificationNumber': None, 'opportunityName': None}], 'invoices': None, 'errors': None, 'itPtips': None, 'createdOffers': None}], 'status': 'Ok', 'messages': []}
Created offer_id: ee92c38f-807b-4d72-46c0-08de1d00de21, offer_number: BTP04776934
URL FullCommerceNew - https://ruecom-intru-tst.ridancorp.net/dapi/api/CrmCommerce/FullCommerceNew?requestId=ee92c38f-807b-4d72-46c0-08de1d00de21
FULL COMMERCE NEW RESPONSE (до UpdateOffer)
{'objects': [{'data': [{'delayedDeliveryDiscountValue': 0.0, 'purchaseType': {'allowPartial': False, 'id': 'c8ec0ee8-fb5d-4ae1-a664-b2c46a914e46', 'value': 'Полная закупка'}, 'paymentSchedule': None, 'completeDeliveryFrom': None, 'paidStorages': None, 'payPercentBeforePlacingIntoProduction': 100, 'filesPO': [], 'filesSA5': [], 'filesSA': [], 'files': [], 'termDate': None, 'sapAuthorPersonNumber': None, 'sapCodeDelivery': None, 'crmPassportNumber': 1150786, 'passportId': '4dbb2a44-d895-468d-a51f-ae98b9b3d487', 'passportResponsiblePhone': None, 'passportResponsibleName': 'test web errors', 'passportResponsibleEmail': 'test_web_errors@ridan.ru', 'passportResponsibleNumber': '00000000', 'endClientOrderInitiator': None, 'specificationTitle': 'Тепловой Пункт/Котельная', 'markupPercentResult': None, 'markupResult': 0.0, 'euroRateOffer': 98.1888, 'clientBroughtAmountResult': 1921189.992, 'currencyDate': '2025-11-06T00:00:00', 'syncDate': None, 'currency': 'RUB', 'vaTcoef': 1.2, 'vaTperc': 20, 'isEndUserPQ': False, 'vaTresult': 224138.832, 'totalVat': 1344833.0, 'total': 1120694.1666666667, 'validDate': '2025-11-20T14:42:26.573', 'validDays': 14, 'totalDistrDiscountPrice': 1344833.0, 'salesPrice': 1600991.66, 'objectCity': None, 'objectAddress': None, 'objectNumber': 1150786, 'objectName': 'Объект только для автотестов! Просьба не изменять в нем ничего!', 'orders': None, 'debtorAccount': 'RT25-7705238125-HE', 'payerDisplay': 'фирма "ВОДОКОМФОРТ" (Офис Москва)', 'payerId': 'acb8f425-c3b6-4b38-9f34-1e7fbfd53fa9', 'paymentTerm': {'code': 'RU00', 'text': 'Предоплата', 'creditDays': 0, 'prepayPercent': 100}, 'endUserClientPerson': None, 'endUserClientId': None, 'endUserClient': 'ООО "ЦЕЛЬСИЙ"', 'createDate': '2025-11-06T14:42:26.577', 'commerceNumber': 'BTP04776934', 'deliveryShortInfo': 'Доставка, со склада в дер. Лешково, Истринский р-на (Московская обл.)  до  (Доставка до терминала, Бесплатно)', 'deliveryCondition': None, 'statusDisplay': 'Черновик', 'status': '5d6f1a5d-3254-44e5-97d7-c4d20f440b61', 'surchargesPayment': 0.0, 'surchargesConvertation': 0.0, 'partialPurchase': False, 'crmCommerceId': 'ee92c38f-807b-4d72-46c0-08de1d00de21', 'salesOffice': 'Москва', 'finalClientInn': '3849013904', 'payerInn': '7705238125', 'deliveryOptions': {'consigneeCode': None, 'condition': None, 'mode': None, 'deliveryType': 'Contract', 'materialType': 'regularCodesMSK', 'deliveryCost': 0, 'deliveryCostInOrderCurrency': 0, 'totalDeliveryWeight': 0, 'comment': None, 'consigneeAgreementDelivery': None, 'clientFinalDelivery': None, 'consigneeContacts': None, 'endPoint': None, 'desiredDeliveryDate': None, 'deliverFullSetOnly': False, 'costIncludedInOrder': False, 'consigneeId': None}, 'deliveryOptionsHex': None, 'deliveryOptionsProd': {'consigneeCode': None, 'condition': None, 'mode': None, 'deliveryType': 'Contract', 'materialType': 'regularCodesMSK', 'deliveryCost': 0, 'deliveryCostInOrderCurrency': 0, 'totalDeliveryWeight': 1043.58, 'comment': None, 'consigneeAgreementDelivery': None, 'clientFinalDelivery': None, 'consigneeContacts': None, 'endPoint': None, 'desiredDeliveryDate': None, 'deliverFullSetOnly': False, 'costIncludedInOrder': False, 'consigneeId': '00000000-0000-0000-0000-000000000000'}, 'deliveryOptionsDZRProd': None, 'availableForDistributor': False, 'isOrder': False, 'isValid': True, 'isITPsuccess': False, 'creatorUserId': '1898a601-d1fe-49e0-9e5e-61432c227d89', 'creatorPersonId': '1c26afd2-1d97-4b7f-92fb-dd21ed412eea', 'creatorDisplay': 'Федоренко Никита Михайлович', 'orderNumber': None, 'sapReferenceNumber': None, 'approvementDeclined': False, 'distrApprovement': None, 'endClientOrderCreator': {'personId': '1c26afd2-1d97-4b7f-92fb-dd21ed412eea', 'email': None, 'phone': None, 'name': 'Ридан'}, 'autoDistrDiscount': None, 'autoFromEngSpec': False, 'finalBayerId': 'daa47b0f-8c66-42f9-a5df-44fae4ff18e8', 'factPaymentPercent': 0.0, 'extendedWarranty': {'type': 'None', 'paymentType': 'None', 'invoiceType': 'None'}, 'isPinnedFinalBuyer': False, 'reservationEnd': None, 'autoClientDiscount': None, 'comments': [], 'endUserPQStatusId': None, 'endUserPQDescription': None, 'confirmTimeByDistr': None, 'responseTimeClient': None, 'opportunityId': 'fb84e31d-11d8-4487-82f8-041fc7e3eefd', 'finalBuyerCDLId': None, 'offerType': 'BTP', 'offerFlags': [], 'showPriceWithDiscount': True, 'showDiscount': False, 'source': 'CRM', 'oneCCurrentStatus': None, 'clientPersonId': None, 'deliveryTerms': None, 'deliveryTermsPTO': None}], 'details': [{'fromMoscow': False, 'weight': 521.79, 'packageSize': -1, 'ptoReadyForShipmentValue': 0, 'islBox': False, 'isBTP': True, 'isPTO': False, 'isTDU': False, 'lineType': 'BTP', 'markupPercentResult': 0.0, 'markupResult': None, 'priceGroup': '80', 'totalVAT': 1344833.0, 'total': 1120694.16, 'vaTresult': 224138.832, 'retailPriceResultNoNDS': 1600991.66, 'retailPriceResult': 1921189.99, 'discount': 0, 'currency': 'RUB', 'salesPrice': 560347.081, 'clientSalesPrice': 800495.83, 'text': 'УВ_Тепловой пункт_N2202248348-1_Тест Шильдика_UV', 'code': 'N2202248348-1', 'materialCode': 'N2202248348-1', 'qty': 2.0, 'id': 'b4dc8470-0de5-4574-ad1f-b5609c8b33f1', 'item': 1, 'hexNumber': None, 'btpNumber': 'N2202248348-1', 'warrantyTotal': 0.0, 'clientDiscountPercent': None, 'clientBroughtAmountResult': 1921189.992, 'availableForOrder': 2.0, 'deliveredCount': 0, 'stockCount': 0, 'packagedCount': 0, 'notPayedCount': 0, 'transit': None, 'isCanceled': False, 'canceledQuantity': 0, 'cancelReason': None, 'isSpecialPrice': False, 'bomSet': None, 'organization': {'contractorId': '20c340fe-6aff-486f-b248-fd8dbe2c93cd', 'inn': '5017132318', 'contractorName': 'ООО "РИДАН ТРЕЙД"', 'approvers': []}, 'shippedAt': None, 'applyedPromo': {'currencyValue': 115.0, 'name': 'Специальное правило расчёта. Применён курс 115 руб., при расчёте стоимости по прайсу.'}, 'invoiceNumber': None, 'invoiceDate': None, 'warehouse': None, 'isExclusiveBTP': False}], 'permissions': {'edit': False, 'moveToDraft': False, 'delete': False, 'addComment': False, 'addFile': False, 'getFile': False}}], 'status': 'Ok', 'messages': []}
Найдено 1 позиций в details
Mapping: N2202248348-1 → b4dc8470-0de5-4574-ad1f-b5609c8b33f1
Contractor: N2202248348-1 → 20c340fe-6aff-486f-b248-fd8dbe2c93cd
✓ Updated ODID for N2202248348-1: b4dc8470-0de5-4574-ad1f-b5609c8b33f1
✓ Updated contractorId for N2202248348-1: 20c340fe-6aff-486f-b248-fd8dbe2c93cd
Updated order lines with ODID: [{'materialCode': 'N2202248348-1', 'quantity': 2, 'lineNumber': 0, 'lineType': 'BTP', 'odid': 'b4dc8470-0de5-4574-ad1f-b5609c8b33f1', 'contractorId': '20c340fe-6aff-486f-b248-fd8dbe2c93cd'}]

  Ожидаем lineType: 'BTP'
  Получили lineType: 'BTP'
  lineType корректен: 'BTP'

================================================================================
ПРОВЕРКА СТАНДАРТНЫХ ПОЛЕЙ ПОСЛЕ CreateOffer → FullCommerceNew
================================================================================

 materialCode: ожидаем 'N2202248348-1', получили 'N2202248348-1'
 quantity: ожидаем 2, получили 2.0
 currency: ожидаем 'RUB', получили 'RUB'
 debtorAccount: ожидаем 'RT25-7705238125-HE', получили 'RT25-7705238125-HE'
 personId: ожидаем '1c26afd2-1d97-4b7f-92fb-dd21ed412eea', получили '1c26afd2-1d97-4b7f-92fb-dd21ed412eea'

 Все стандартные поля корректны!
================================================================================

Original Seller ID: 20c340fe-6aff-486f-b248-fd8dbe2c93cd
Original Contractor Name: ООО "РИДАН ТРЕЙД"
OpportunityId из FullCommerceNew: fb84e31d-11d8-4487-82f8-041fc7e3eefd

================================================================================
UPDATE OFFER PAYLOAD (что отправляем):
{'source': 'CRM', 'currency': 'RUB', 'exchangeRateType': 'YRU', 'debtorAccount': 'RT25-7705238125-HE', 'personId': '1c26afd2-1d97-4b7f-92fb-dd21ed412eea', 'paymentTerms': 'RU00', 'offerId': 'ee92c38f-807b-4d72-46c0-08de1d00de21', 'opportunityId': 'fb84e31d-11d8-4487-82f8-041fc7e3eefd', 'orderLines': [{'materialCode': 'N2202248348-1', 'quantity': 3, 'lineNumber': 0, 'lineType': 'BTP', 'odid': 'b4dc8470-0de5-4574-ad1f-b5609c8b33f1', 'contractorId': '20c340fe-6aff-486f-b248-fd8dbe2c93cd', 'discountPercent': 10, 'endClientDiscountPercent': 10}], 'isDraft': False, 'deliveryOptionsProd': {'consigneeId': '00000000-0000-0000-0000-000000000000'}, 'passportId': '4DBB2A44-D895-468D-A51F-AE98B9B3D487', 'specTypeId': '02061701-51E6-402E-B18F-7BAE7A27F6FB', 'specificationId': '29CDC69A-1CBA-47CF-9F93-8DECBDAF3D9A', 'purchaseType': 'C8EC0EE8-FB5D-4AE1-A664-B2C46A914E46', 'finalBuyerId': 'daa47b0f-8c66-42f9-a5df-44fae4ff18e8', 'customerId': 'acb8f425-c3b6-4b38-9f34-1e7fbfd53fa9', 'currencySpecialFixation': True, 'setContractDiscounts': True, 'userComment': 'ТЕСТ флоу методов - UpdateOffer'}
================================================================================

UPDATE OFFER RESPONSE
{'objects': [{'status': True}], 'status': 'Ok', 'messages': []}
✓ UpdateOffer успешно выполнен!
URL FullCommerceNew - https://ruecom-intru-tst.ridancorp.net/dapi/api/CrmCommerce/FullCommerceNew?requestId=ee92c38f-807b-4d72-46c0-08de1d00de21
FULL COMMERCE NEW RESPONSE (после UpdateOffer)
{'objects': [{'data': [{'delayedDeliveryDiscountValue': 0.0, 'purchaseType': {'allowPartial': False, 'id': 'c8ec0ee8-fb5d-4ae1-a664-b2c46a914e46', 'value': 'Полная закупка'}, 'paymentSchedule': None, 'completeDeliveryFrom': None, 'paidStorages': None, 'payPercentBeforePlacingIntoProduction': 100, 'filesPO': [], 'filesSA5': [], 'filesSA': [], 'files': [], 'termDate': '2025-11-20T23:59:59', 'sapAuthorPersonNumber': None, 'sapCodeDelivery': None, 'crmPassportNumber': 1150786, 'passportId': '4dbb2a44-d895-468d-a51f-ae98b9b3d487', 'passportResponsiblePhone': None, 'passportResponsibleName': 'test web errors', 'passportResponsibleEmail': 'test_web_errors@ridan.ru', 'passportResponsibleNumber': '00000000', 'endClientOrderInitiator': None, 'specificationTitle': 'Тепловой Пункт/Котельная', 'markupPercentResult': None, 'markupResult': 0.0, 'euroRateOffer': 98.1888, 'clientBroughtAmountResult': 2593606.5, 'currencyDate': '2025-11-06T00:00:00', 'syncDate': None, 'currency': 'RUB', 'vaTcoef': 1.2, 'vaTperc': 20, 'isEndUserPQ': False, 'vaTresult': 432267.75, 'totalVat': 2593606.5, 'total': 2161338.75, 'validDate': '2025-11-20T14:42:28.63', 'validDays': 14, 'totalDistrDiscountPrice': 2593606.5, 'salesPrice': 2401487.49, 'objectCity': None, 'objectAddress': None, 'objectNumber': 1150786, 'objectName': 'Объект только для автотестов! Просьба не изменять в нем ничего!', 'orders': None, 'debtorAccount': 'RT25-7705238125-HE', 'payerDisplay': 'фирма "ВОДОКОМФОРТ" (Офис Москва)', 'payerId': 'acb8f425-c3b6-4b38-9f34-1e7fbfd53fa9', 'paymentTerm': {'code': 'RU00', 'text': 'Предоплата', 'creditDays': 0, 'prepayPercent': 100}, 'endUserClientPerson': None, 'endUserClientId': None, 'endUserClient': 'ООО "ЦЕЛЬСИЙ"', 'createDate': '2025-11-06T14:42:26.577', 'commerceNumber': 'BTP04776934', 'deliveryShortInfo': 'Доставка, со склада в дер. Лешково, Истринский р-на (Московская обл.)  до  (Доставка до терминала, Бесплатно)', 'deliveryCondition': None, 'statusDisplay': 'Готов', 'status': '68c12a88-973a-4f7f-88aa-4242a1f81f40', 'surchargesPayment': 0.0, 'surchargesConvertation': 0.0, 'partialPurchase': False, 'crmCommerceId': 'ee92c38f-807b-4d72-46c0-08de1d00de21', 'salesOffice': 'Москва', 'finalClientInn': '3849013904', 'payerInn': '7705238125', 'deliveryOptions': {'consigneeCode': None, 'condition': None, 'mode': None, 'deliveryType': 'Contract', 'materialType': 'regularCodesMSK', 'deliveryCost': 0, 'deliveryCostInOrderCurrency': 0, 'totalDeliveryWeight': 0, 'comment': None, 'consigneeAgreementDelivery': None, 'clientFinalDelivery': None, 'consigneeContacts': None, 'endPoint': None, 'desiredDeliveryDate': None, 'deliverFullSetOnly': False, 'costIncludedInOrder': False, 'consigneeId': None}, 'deliveryOptionsHex': None, 'deliveryOptionsProd': {'consigneeCode': None, 'condition': None, 'mode': None, 'deliveryType': 'Contract', 'materialType': 'regularCodesMSK', 'deliveryCost': 0, 'deliveryCostInOrderCurrency': 0, 'totalDeliveryWeight': 1565.37, 'comment': None, 'consigneeAgreementDelivery': None, 'clientFinalDelivery': None, 'consigneeContacts': None, 'endPoint': None, 'desiredDeliveryDate': None, 'deliverFullSetOnly': False, 'costIncludedInOrder': False, 'consigneeId': '00000000-0000-0000-0000-000000000000'}, 'deliveryOptionsDZRProd': None, 'availableForDistributor': True, 'isOrder': False, 'isValid': True, 'isITPsuccess': False, 'creatorUserId': '1898a601-d1fe-49e0-9e5e-61432c227d89', 'creatorPersonId': '1c26afd2-1d97-4b7f-92fb-dd21ed412eea', 'creatorDisplay': 'Федоренко Никита Михайлович', 'orderNumber': None, 'sapReferenceNumber': None, 'approvementDeclined': False, 'distrApprovement': None, 'endClientOrderCreator': {'personId': '1c26afd2-1d97-4b7f-92fb-dd21ed412eea', 'email': None, 'phone': None, 'name': 'Ридан'}, 'autoDistrDiscount': None, 'autoFromEngSpec': False, 'finalBayerId': 'daa47b0f-8c66-42f9-a5df-44fae4ff18e8', 'factPaymentPercent': 0.0, 'extendedWarranty': {'type': 'None', 'paymentType': 'None', 'invoiceType': 'None'}, 'isPinnedFinalBuyer': False, 'reservationEnd': None, 'autoClientDiscount': None, 'comments': [], 'endUserPQStatusId': None, 'endUserPQDescription': None, 'confirmTimeByDistr': None, 'responseTimeClient': None, 'opportunityId': 'fb84e31d-11d8-4487-82f8-041fc7e3eefd', 'finalBuyerCDLId': None, 'offerType': 'BTP', 'offerFlags': [], 'showPriceWithDiscount': True, 'showDiscount': False, 'source': 'CRM', 'oneCCurrentStatus': None, 'clientPersonId': None, 'deliveryTerms': None, 'deliveryTermsPTO': None}], 'details': [{'fromMoscow': False, 'weight': 521.79, 'packageSize': -1, 'ptoReadyForShipmentValue': 0, 'islBox': False, 'isBTP': True, 'isPTO': False, 'isTDU': False, 'lineType': 'BTP', 'markupPercentResult': 0.0, 'markupResult': None, 'priceGroup': '80', 'totalVAT': 2593606.5, 'total': 2161338.75, 'vaTresult': 432267.75, 'retailPriceResultNoNDS': 2401487.49, 'retailPriceResult': 2881784.99, 'discount': 0, 'currency': 'RUB', 'salesPrice': 720446.247, 'clientSalesPrice': 720446.247, 'text': 'УВ_Тепловой пункт_N2202248348-1_Тест Шильдика_UV', 'code': 'N2202248348-1', 'materialCode': 'N2202248348-1', 'qty': 3.0, 'id': 'b4dc8470-0de5-4574-ad1f-b5609c8b33f1', 'item': 1, 'hexNumber': None, 'btpNumber': 'N2202248348-1', 'warrantyTotal': 0.0, 'clientDiscountPercent': 10.0, 'clientBroughtAmountResult': 2593606.5, 'availableForOrder': 3.0, 'deliveredCount': 0, 'stockCount': 0, 'packagedCount': 0, 'notPayedCount': 0, 'transit': None, 'isCanceled': False, 'canceledQuantity': 0, 'cancelReason': None, 'isSpecialPrice': False, 'bomSet': None, 'organization': {'contractorId': '20c340fe-6aff-486f-b248-fd8dbe2c93cd', 'inn': '5017132318', 'contractorName': 'ООО "РИДАН ТРЕЙД"', 'approvers': []}, 'shippedAt': None, 'applyedPromo': {'currencyValue': 115.0, 'name': 'Специальное правило расчёта. Применён курс 115 руб., при расчёте стоимости по прайсу.'}, 'invoiceNumber': None, 'invoiceDate': None, 'warehouse': None, 'isExclusiveBTP': False}], 'permissions': {'edit': False, 'moveToDraft': False, 'delete': False, 'addComment': False, 'addFile': False, 'getFile': False}}], 'status': 'Ok', 'messages': []}

Проверка количества для N2202248348-1:
  Ожидаем: 3
  Получили: 3.0
✓ Количество корректно!

Проверка скидки для N2202248348-1:
  Ожидаем: 10%
  Получили: 10.0%
✓ Скидка корректна!

================================================================================
ПРОВЕРКА ПОЛЕЙ ПОСЛЕ UpdateOffer → FullCommerceNew
================================================================================

 materialCode: ожидаем 'N2202248348-1', получили 'N2202248348-1'
 quantity: ожидаем 3, получили 3.0
 discount: ожидаем 10%, получили 10.0%
 currency: ожидаем 'RUB', получили 'RUB'
 debtorAccount: ожидаем 'RT25-7705238125-HE', получили 'RT25-7705238125-HE'
 personId: ожидаем '1c26afd2-1d97-4b7f-92fb-dd21ed412eea', получили '1c26afd2-1d97-4b7f-92fb-dd21ed412eea'
 lineType: ожидаем 'BTP', получили 'BTP'

 Все поля после UpdateOffer корректны!
================================================================================

✓ Все изменения успешно применились!
Найдено 1 позиций в details
Mapping: N2202248348-1 → b4dc8470-0de5-4574-ad1f-b5609c8b33f1
Contractor: N2202248348-1 → 20c340fe-6aff-486f-b248-fd8dbe2c93cd
✓ Updated ODID for N2202248348-1: b4dc8470-0de5-4574-ad1f-b5609c8b33f1
✓ Updated contractorId for N2202248348-1: 20c340fe-6aff-486f-b248-fd8dbe2c93cd
ORDER CREATE PAYLOAD
{'orderLines': [{'materialCode': 'N2202248348-1', 'quantity': 3, 'lineNumber': 0, 'lineType': 'BTP', 'odid': 'b4dc8470-0de5-4574-ad1f-b5609c8b33f1', 'contractorId': '20c340fe-6aff-486f-b248-fd8dbe2c93cd', 'discountPercent': 10, 'endClientDiscountPercent': 10}], 'isEndUserPQ': False, 'docType': 'Quotation', 'authorNumber': '0000612383', 'currencyDate': None, 'exchangeRateType': None, 'projectDiscountConditions': False, 'debtorAccount': 'RT25-7705238125-HE', 'finalBuyerCDLId': None, 'clientInn': None, 'userComment': 'ТЕСТ флоу методов - Order/Create', 'engineerComment': '', 'currency': 'RUB', 'methodCode': 'ZWEB', 'purchaseDate': '2024-09-27T12:18:27+03:00', 'delayedDeliveryDiscountValue': None, 'personId': '920bb836-8ee4-4571-b5bd-94bd28c29d32', 'offerId': 'ee92c38f-807b-4d72-46c0-08de1d00de21', 'passportId': None, 'opportunityId': None, 'specTypeId': None, 'specificationId': None, 'salesGroup': 'RU1', 'salesOffice': 'RU01', 'referenceNumber': 'Z0000052452', 'paymentTerms': 'RU00', 'isDraft': False, 'purchaseType': None, 'finalBuyerId': None, 'availableForDistributor': False, 'autoAvailableForDistributor': None, 'payPercentComponentsBTP': None, 'payPercentBeforePlacingIntoProduction': None, 'customerId': None, 'isCLHOffer': False, 'deliveryOptionsHex': None, 'deliveryOptionsProd': {'consigneeCode': None, 'condition': 'RU', 'mode': 16, 'deliveryCost': 0, 'totalDeliveryWeight': 20.889, 'comment': '', 'consigneeAgreementDelivery': None, 'clientFinalDelivery': None, 'consigneeContacts': None, 'endPoint': 'ToDoor', 'desiredDeliveryDate': '2024-09-30T12:18:27+03:00', 'deliverFullSetOnly': False, 'costIncludedInOrder': False, 'consigneeId': '00000000-0000-0000-0000-000000000000', 'deliveryType': 'Pickup'}, 'deliveryOptionsDZRProd': None, 'deliveryNotificationSettings': None, 'projectObject': None, 'setContractDiscounts': False, 'currencySpecialFixation': False, 'extendValidit': 0, 'showPriceWithDiscount': False, 'showDiscount': False, 'finalMarkup': None, 'surchargesPayment': None, 'surchargesConversion': None, 'recommendedDistributors': []}
ORDER CREATE RESPONSE
{'objects': [{'id': 'e556d490-931c-47bf-46c1-08de1d00de21', 'docNumber': 'BTP04776934', 'referenceNumber': None, 'hexReferenceNumbers': ['BTP04776934-1'], 'offer': {'offerId': 'ee92c38f-807b-4d72-46c0-08de1d00de21', 'offerNumber': 'BTP04776934'}, 'orders': [{'orderNumber': None, 'orderType': 'BTP', 'offerId': 'e556d490-931c-47bf-46c1-08de1d00de21', 'offerNumber': 'BTP04776934-1'}]}], 'status': 'Ok', 'messages': []}
Тест успешно выполнен! Весь цикл с UpdateOffer завершен.
PASSED
=== Running test for: Clever Hit HEX code - with promoCurrency and userName ===
SIMULATE RESPONSE
{'objects': [{'orderLines': [{'bomLines': [], 'schedules': [{'lineNumber': 1, 'confirmedQuantity': 1, 'correctedQuantity': 1, 'orderedQuantity': 1, 'deliveryDate': '2025-11-16T14:42:31.2911646+03:00', 'correctedDeliveryDate': '2 раб.нед.', 'scheduleType': 'Transit'}], 'odid': None, 'copiedFromId': None, 'lineNumber': 1, 'hasPromo': True, 'sourceLineNumber': 1, 'materialCode': 'w003013006', 'altMaterialCode': 'w003013006', 'description': 'Аппарат теплообменный CLH32S', 'descriptionExtended': None, 'salesPrice': 142010.05, 'warrantyPrice': 0, 'width': 0, 'weight': 40.85, 'orderedQuantity': 1, 'availableQuantity': 0, 'transitQuantity': 1, 'confirmedDeliveryDate': '2025-11-16T14:42:31.2911646+03:00', 'deliveryTimeStandard': '', 'surchargesPrice': 63904.5225, 'surchargesPercent': 0, 'tax': 12780.9045, 'discount': 0, 'discountPercent': 55.0, 'corridorCooficient': None, 'clientDiscountPercent': 0, 'distrDiscountPercent': 55.0, 'distrContractDiscount': 55.0, 'distrMaxDiscount': 0, 'approvedDiscount': None, 'currency': 'RUB', 'cost': 21957.81, 'costCurrency': 'RUB', 'salesPriceWithTax': 76685.427, 'comments': [], 'category': None, 'statuses': [{'code': 3, 'description': 'Специальное правило расчёта. Применён курс 115 руб., при расчёте стоимости по прайсу.'}], 'lineType': 'HEX', 'mpg': 'YA', 'areaActivity': {'id': 'aff0fafb-0e4e-11ed-9528-5254008cf63f', 'description': 'Теплоавтоматика РФ'}, 'gfu': {'id': '890603f9-0890-4839-0625-08dbf7c34296', 'description': '43 Готовая продукция'}, 'materialSubType': None, 'availability': {'requestedQty': 1, 'onStockQty': 0, 'transit': [{'quantity': 1, 'date': '2025-11-16T14:42:31.2911646+03:00', 'documentType': 'OrderedByDistributor'}], 'onTransitQty': 1, 'transitDate': '2025-11-16T14:42:31.2911646+03:00', 'notAvailableQty': 0, 'deliveryWeeks': 2, 'deliveryDays': 10, 'deliveryTimeStandard': '2 недели'}, 'isSpecialPrice': False, 'isCorrectedQuantity': False, 'allowCreateDueDeliveryTicket': False, 'isZeroPrices': False, 'lockCode': None, 'isManufactureReserved': False, 'equipmentCategoryId': '52550619-62b2-4aaf-82ab-8ca26830ec7f', 'equipmentCategory': 'Теплообменник', 'packageSize': 0, 'promoCurrencyValue': 115.0, 'autoDistrPosDiscount': 0, 'autoClientPosDiscount': 0, 'excludePosition': False, 'sourcePrice': None, 'specialPrice': None, 'tenderAmount': None, 'calc': {'id': '8c266328-5c1f-405b-bc89-c5337488767a', 'number': 'w003013006', 'materialCode': None, 'calcType': 'HEX', 'assembleTimeCost': 26.44}}], 'orderParty': {'currency': 'RUB', 'customerGroup': None, 'debtorAccount': 'RT25-7705238125-HE', 'deliveryAddress': None, 'deliveryMode': None, 'deliveryPlant': None, 'paymentTerms': 'RU00', 'salesGroup': '', 'salesOffice': '', 'exchangeRate': 98.054, 'deliveryModeText': None, 'deliveryPlantName': None, 'salesOfficeText': '', 'salesGroupText': '', 'paymentTermsText': '', 'currencyDate': '2025-11-05T00:00:00', 'exchangeRateType': 'YRU'}, 'deliveryReceivers': [], 'itPtips': None, 'discountTips': None, 'discountTip': None, 'volumeDiscountTips': [], 'kitDiscountTips': [], 'authoPriceResults': None, 'sourceTenderOffer': None}], 'status': 'Ok', 'messages': []}
Исходное количество из Simulate: 1
Order lines from Simulate: [{'materialCode': 'w003013006', 'quantity': 1, 'lineNumber': 1, 'lineType': 'HEX', 'odid': None, 'deliveryDate': '2025-11-16T14:42:31.2911646+03:00'}]

================================================================================
CREATE OFFER PAYLOAD (что отправляем):
{'source': None, 'currency': 'RUB', 'exchangeRateType': 'YRU', 'debtorAccount': 'RT25-7705238125-HE', 'personId': 'f8eaae4a-1309-4b24-95e8-3a092dc30067', 'paymentTerms': 'RU00', 'orderLines': [{'materialCode': 'w003013006', 'quantity': 1, 'lineNumber': 1, 'lineType': 'HEX', 'odid': None, 'deliveryDate': '2025-11-16T14:42:31.2911646+03:00'}], 'isDraft': True, 'deliveryOptionsDZRProd': {'ConsigneeCode': None, 'Condition': 'RU', 'DeliveryCost': 0, 'ClientFinalDelivery': None, 'ConsigneeContacts': None, 'consigneeAgreementDelivery': {'SourceFiasId': '00000000-0000-0000-0000-000000000000', 'Address': '', 'PaidDelivery': False, 'ConditionDescription': 'Стандартные договорные условия', 'INN': '6167138751'}, 'CostIncludedInOrder': False, 'totalDeliveryWeight': 40.85, 'endPoint': 'ToTK', 'deliveryType': 'PickupDZR', 'consigneeId': '00000000-0000-0000-0000-000000000000', 'deliverFullSetOnly': False}, 'projectObject': {'id': '8BE18628-2E23-4650-A438-482484E0B64D', 'name': 'Детский сад на 240 мест в г. Тарко-Сале, мкр.Южный', 'address': 'Ямало-Ненецкий АО, г Тарко-Сале, мкр Южный', 'number': 1178586, 'comment': ' '}, 'docType': 'Order', 'showPriceWithDiscount': True, 'showDiscount': False, 'currencyDate': '2025-11-05T00:00:00', 'userName': 'RIDANCORP\\RUCO3670', 'usePromoCurrency': True, 'passportId': '8BE18628-2E23-4650-A438-482484E0B64D', 'specTypeId': '02061701-51E6-402E-B18F-7BAE7A27F6FB', 'specificationId': '0E59258B-B7AA-434F-877E-EFD37BE5930F', 'surchargesPayment': '0', 'surchargesConversion': 0, 'payPercentBeforePlacingIntoProduction': 100, 'isEndUserPQ': False, 'purchaseType': '121B015A-E76D-4688-9BB6-2A56EC6DE2EF', 'finalBuyerId': 'e55f3bae-ef45-43bd-b2f6-9f0148ca5622', 'customerId': 'acb8f425-c3b6-4b38-9f34-1e7fbfd53fa9', 'clientInn': '7705238125', 'autoAvailableForDistributor': None, 'currencySpecialFixation': True, 'setContractDiscounts': True, 'isExport': False, 'validDays': 14, 'sellerId': '20C340FE-6AFF-486F-B248-FD8DBE2C93CD', 'IsATOffer': False, 'autoFromEngSpec': False, 'isNew': True, 'extendedWarranty': {'type': '0'}, 'priceFixingCorridorValue': None, 'isEstimateOffer': False, 'offerType': None, 'regionsValidityAT': None, 'userComment': 'ТЕСТ флоу методов CleverHit - CreateOffer'}
================================================================================

CREATE OFFER RESPONSE
{'objects': [{'lines': [{'remark': None, 'avaliability': [], 'bomSet': None, 'salesPrice': 63904.52, 'cost': None, 'costCurrency': None, 'quantity': 1, 'description': 'Аппарат теплообменный CLH32S', 'code': 'w003013006', 'altMaterialCode': None, 'totalWithDiscountSurchargesAndVAT': 76685.427, 'totalWithDiscountAndSurcharges': None, 'totalWithDiscount': None, 'surchargesDelayPercent': None, 'surchargesCurrencyConversionPercent': None, 'discountAmount': None, 'discountPercent': 55.0, 'weight': None, 'deliveryWeeks': 0, 'calcNumber': None, 'calculationComment': None, 'comment': None, 'isSpecial': 0, 'isProtected': False, 'calcId': None, 'hexIsReady': False, 'clientDiscountPercent': None, 'clientBroughtAmountResult': None, 'itpDiscountPercent': None, 'contractDiscountPercent': None, 'sourceNOrder': 1, 'positionOrder': 1, 'warrantyTotal': None, 'salesPriceWithoutDiscount': 142010.05, 'totalWithoutDiscount': 142010.05, 'subType': 'Import', 'mpg': None, 'prodHierarchy': None, 'category': None, 'taxes': 0, 'abcCategory': None, 'equipmentCategoryId': None, 'equipmentCategory': None, 'surchargePercent': 0}], 'offers': [{'sapReferenceNumber': None, 'paymentTerms': None, 'exchangeRate': 0, 'deliveryPlant': None, 'deliveryMode': None, 'deliveryAddress': None, 'debtorAccount': None, 'currency': 'RUB', 'broughtAmountResult': 76685.427, 'number': 'CLH04776935', 'id': '83353a6d-6b02-4f5d-46c2-08de1d00de21', 'isITPsuccess': None, 'crmUrl': None, 'clientBroughtAmountResult': 0, 'pObjectName': None, 'pObjectNumber': None, 'specificationNumber': None, 'opportunityName': None}], 'invoices': None, 'errors': None, 'itPtips': None, 'createdOffers': None}], 'status': 'Ok', 'messages': []}
Created offer_id: 83353a6d-6b02-4f5d-46c2-08de1d00de21, offer_number: CLH04776935
URL FullCommerceNew - https://ruecom-intru-tst.ridancorp.net/dapi/api/CrmCommerce/FullCommerceNew?requestId=83353a6d-6b02-4f5d-46c2-08de1d00de21
FULL COMMERCE NEW RESPONSE (до UpdateOffer)
{'objects': [{'data': [{'delayedDeliveryDiscountValue': 0.0, 'purchaseType': {'allowPartial': True, 'id': '121b015a-e76d-4688-9bb6-2a56ec6de2ef', 'value': 'Частичная закупка'}, 'paymentSchedule': None, 'completeDeliveryFrom': None, 'paidStorages': None, 'payPercentBeforePlacingIntoProduction': 100, 'filesPO': [], 'filesSA5': [], 'filesSA': [], 'files': [], 'termDate': None, 'sapAuthorPersonNumber': None, 'sapCodeDelivery': None, 'crmPassportNumber': 1193176, 'passportId': '8be18628-2e23-4650-a438-482484e0b64d', 'passportResponsiblePhone': '+7 (985) 266-93-35', 'passportResponsibleName': 'Анисимов Александр', 'passportResponsibleEmail': 'anisimov@ridan.ru', 'passportResponsibleNumber': '00001683', 'endClientOrderInitiator': None, 'specificationTitle': 'Тепловой Пункт/Котельная', 'markupPercentResult': None, 'markupResult': 0.0, 'euroRateOffer': 98.054, 'clientBroughtAmountResult': 170412.06, 'currencyDate': '2025-11-05T00:00:00', 'syncDate': None, 'currency': 'RUB', 'vaTcoef': 1.2, 'vaTperc': 20, 'isEndUserPQ': False, 'vaTresult': 12780.9045, 'totalVat': 76685.427, 'total': 63904.5225, 'validDate': '2025-11-20T14:42:32.353', 'validDays': 14, 'totalDistrDiscountPrice': 76685.427, 'salesPrice': 142010.05, 'objectCity': None, 'objectAddress': 'г Москва, ул Арбат, д 1', 'objectNumber': 1193176, 'objectName': 'test.092025', 'orders': None, 'debtorAccount': 'RT25-7705238125-HE', 'payerDisplay': 'фирма "ВОДОКОМФОРТ" (Офис Москва)', 'payerId': 'acb8f425-c3b6-4b38-9f34-1e7fbfd53fa9', 'paymentTerm': {'code': 'RU00', 'text': 'Предоплата', 'creditDays': 0, 'prepayPercent': 100}, 'endUserClientPerson': None, 'endUserClientId': None, 'endUserClient': 'ООО "ЭНТЕЗА"', 'createDate': '2025-11-06T14:42:32.353', 'commerceNumber': 'CLH04776935', 'deliveryShortInfo': 'Доставка, со склада в дер. Лешково, Истринский р-на (Московская обл.)  до  (Доставка до терминала, Бесплатно)', 'deliveryCondition': None, 'statusDisplay': 'Черновик', 'status': '5d6f1a5d-3254-44e5-97d7-c4d20f440b61', 'surchargesPayment': 0.0, 'surchargesConvertation': 0.0, 'partialPurchase': True, 'crmCommerceId': '83353a6d-6b02-4f5d-46c2-08de1d00de21', 'salesOffice': 'Москва', 'finalClientInn': '6167138751', 'payerInn': '7705238125', 'deliveryOptions': {'consigneeCode': None, 'condition': None, 'mode': None, 'deliveryType': 'Contract', 'materialType': 'regularCodesMSK', 'deliveryCost': 0, 'deliveryCostInOrderCurrency': 0, 'totalDeliveryWeight': 0, 'comment': None, 'consigneeAgreementDelivery': None, 'clientFinalDelivery': None, 'consigneeContacts': None, 'endPoint': None, 'desiredDeliveryDate': None, 'deliverFullSetOnly': False, 'costIncludedInOrder': False, 'consigneeId': None}, 'deliveryOptionsHex': None, 'deliveryOptionsProd': None, 'deliveryOptionsDZRProd': {'consigneeCode': None, 'condition': 'RU', 'mode': None, 'deliveryType': 'PickupDZR', 'materialType': 'regularCodesMSK', 'deliveryCost': 0, 'deliveryCostInOrderCurrency': 0, 'totalDeliveryWeight': 40.85, 'comment': None, 'consigneeAgreementDelivery': {'conditionDescription': 'Стандартные договорные условия', 'inn': '6167138751', 'kpp': None, 'sourceFiasId': '00000000-0000-0000-0000-000000000000', 'destinationFiasId': None, 'destinationRegionFiasId': None, 'address': '', 'paidDelivery': False}, 'clientFinalDelivery': None, 'consigneeContacts': None, 'endPoint': 'ToTK', 'desiredDeliveryDate': None, 'deliverFullSetOnly': False, 'costIncludedInOrder': False, 'consigneeId': '00000000-0000-0000-0000-000000000000'}, 'availableForDistributor': False, 'isOrder': False, 'isValid': True, 'isITPsuccess': False, 'creatorUserId': '770b060c-4a2f-4638-adbb-dfbeb1813754', 'creatorPersonId': 'f8eaae4a-1309-4b24-95e8-3a092dc30067', 'creatorDisplay': 'Баженов Дмитрий Евгеньевич', 'orderNumber': None, 'sapReferenceNumber': None, 'approvementDeclined': False, 'distrApprovement': None, 'endClientOrderCreator': {'personId': 'f8eaae4a-1309-4b24-95e8-3a092dc30067', 'email': 'bazhenov_d@ridan.ru', 'phone': '+7 (962) 511-14-45', 'name': 'Ридан'}, 'autoDistrDiscount': None, 'autoFromEngSpec': False, 'finalBayerId': 'e55f3bae-ef45-43bd-b2f6-9f0148ca5622', 'factPaymentPercent': 0.0, 'extendedWarranty': {'type': 'None', 'paymentType': 'None', 'invoiceType': 'None'}, 'isPinnedFinalBuyer': False, 'reservationEnd': None, 'autoClientDiscount': None, 'comments': [], 'endUserPQStatusId': None, 'endUserPQDescription': None, 'confirmTimeByDistr': None, 'responseTimeClient': None, 'opportunityId': '09f15189-474d-4fa3-ac0f-478e289d9f32', 'finalBuyerCDLId': None, 'offerType': 'CLH', 'offerFlags': [], 'showPriceWithDiscount': True, 'showDiscount': False, 'source': None, 'oneCCurrentStatus': None, 'clientPersonId': None, 'deliveryTerms': None, 'deliveryTermsPTO': None}], 'details': [{'fromMoscow': False, 'weight': 40.85, 'packageSize': -1, 'ptoReadyForShipmentValue': None, 'islBox': False, 'isBTP': False, 'isPTO': True, 'isTDU': False, 'lineType': 'HEX', 'markupPercentResult': 0.0, 'markupResult': None, 'priceGroup': 'YA', 'totalVAT': 76685.427, 'total': 63904.5225, 'vaTresult': 12780.9045, 'retailPriceResultNoNDS': 142010.05, 'retailPriceResult': 170412.06, 'discount': 0, 'currency': 'RUB', 'salesPrice': 63904.5225, 'clientSalesPrice': 142010.05, 'text': 'Аппарат теплообменный CLH32S', 'code': 'w003013006', 'materialCode': None, 'qty': 1.0, 'id': 'e72c1085-b11e-44e1-ac34-502ee460b752', 'item': 1, 'hexNumber': 'w003013006', 'btpNumber': None, 'warrantyTotal': 0.0, 'clientDiscountPercent': None, 'clientBroughtAmountResult': 170412.06, 'availableForOrder': 1.0, 'deliveredCount': 0, 'stockCount': 0, 'packagedCount': 0, 'notPayedCount': 0, 'transit': None, 'isCanceled': False, 'canceledQuantity': 0, 'cancelReason': None, 'isSpecialPrice': False, 'bomSet': None, 'organization': {'contractorId': '20c340fe-6aff-486f-b248-fd8dbe2c93cd', 'inn': '5017132318', 'contractorName': 'ООО "РИДАН ТРЕЙД"', 'approvers': []}, 'shippedAt': None, 'applyedPromo': {'currencyValue': 115.0, 'name': 'Специальное правило расчёта. Применён курс 115 руб., при расчёте стоимости по прайсу.'}, 'invoiceNumber': None, 'invoiceDate': None, 'warehouse': None, 'isExclusiveBTP': False}], 'permissions': {'edit': False, 'moveToDraft': False, 'delete': False, 'addComment': False, 'addFile': False, 'getFile': False}}], 'status': 'Ok', 'messages': []}
Найдено 1 позиций в details
Mapping: w003013006 → e72c1085-b11e-44e1-ac34-502ee460b752
Contractor: w003013006 → 20c340fe-6aff-486f-b248-fd8dbe2c93cd
✓ Updated ODID for w003013006: e72c1085-b11e-44e1-ac34-502ee460b752
✓ Updated contractorId for w003013006: 20c340fe-6aff-486f-b248-fd8dbe2c93cd
Updated order lines with ODID: [{'materialCode': 'w003013006', 'quantity': 1, 'lineNumber': 1, 'lineType': 'HEX', 'odid': 'e72c1085-b11e-44e1-ac34-502ee460b752', 'deliveryDate': '2025-11-16T14:42:31.2911646+03:00', 'contractorId': '20c340fe-6aff-486f-b248-fd8dbe2c93cd'}]

  Ожидаем lineType: 'HEX'
  Получили lineType: 'HEX'
  lineType корректен: 'HEX'

================================================================================
ПРОВЕРКА СТАНДАРТНЫХ ПОЛЕЙ ПОСЛЕ CreateOffer → FullCommerceNew
================================================================================

 materialCode: ожидаем 'w003013006', получили 'w003013006'
 quantity: ожидаем 1, получили 1.0
 currency: ожидаем 'RUB', получили 'RUB'
 debtorAccount: ожидаем 'RT25-7705238125-HE', получили 'RT25-7705238125-HE'
 personId: ожидаем 'f8eaae4a-1309-4b24-95e8-3a092dc30067', получили 'f8eaae4a-1309-4b24-95e8-3a092dc30067'
 INN в deliveryOptions: ожидаем '6167138751', получили '6167138751'
 totalDeliveryWeight: ожидаем 40.85, получили 40.85

 Все стандартные поля корректны!
================================================================================

Original Seller ID: 20c340fe-6aff-486f-b248-fd8dbe2c93cd
Original Contractor Name: ООО "РИДАН ТРЕЙД"
OpportunityId из FullCommerceNew: 09f15189-474d-4fa3-ac0f-478e289d9f32

================================================================================
UPDATE OFFER PAYLOAD (что отправляем):
{'source': None, 'currency': 'RUB', 'exchangeRateType': 'YRU', 'debtorAccount': 'RT25-7705238125-HE', 'personId': 'f8eaae4a-1309-4b24-95e8-3a092dc30067', 'paymentTerms': 'RU00', 'offerId': '83353a6d-6b02-4f5d-46c2-08de1d00de21', 'opportunityId': '09f15189-474d-4fa3-ac0f-478e289d9f32', 'orderLines': [{'materialCode': 'w003013006', 'quantity': 2, 'lineNumber': 1, 'lineType': 'HEX', 'odid': 'e72c1085-b11e-44e1-ac34-502ee460b752', 'deliveryDate': '2025-11-16T14:42:31.2911646+03:00', 'contractorId': '20c340fe-6aff-486f-b248-fd8dbe2c93cd', 'discountPercent': 55, 'endClientDiscountPercent': 55}], 'isDraft': False, 'deliveryOptionsDZRProd': {'ConsigneeCode': None, 'Condition': 'RU', 'DeliveryCost': 0, 'ClientFinalDelivery': None, 'ConsigneeContacts': None, 'consigneeAgreementDelivery': {'SourceFiasId': '00000000-0000-0000-0000-000000000000', 'Address': '', 'PaidDelivery': False, 'ConditionDescription': 'Стандартные договорные условия', 'INN': '6167138751'}, 'CostIncludedInOrder': False, 'totalDeliveryWeight': 40.85, 'endPoint': 'ToTK', 'deliveryType': 'PickupDZR', 'consigneeId': '00000000-0000-0000-0000-000000000000', 'deliverFullSetOnly': False}, 'projectObject': {'id': '8BE18628-2E23-4650-A438-482484E0B64D', 'name': 'Детский сад на 240 мест в г. Тарко-Сале, мкр.Южный', 'address': 'Ямало-Ненецкий АО, г Тарко-Сале, мкр Южный', 'number': 1178586, 'comment': ' '}, 'docType': 'Order', 'showPriceWithDiscount': True, 'showDiscount': False, 'currencyDate': '2025-11-05T00:00:00', 'userName': 'RIDANCORP\\RUCO3670', 'usePromoCurrency': True, 'passportId': '8BE18628-2E23-4650-A438-482484E0B64D', 'specTypeId': '02061701-51E6-402E-B18F-7BAE7A27F6FB', 'specificationId': '0E59258B-B7AA-434F-877E-EFD37BE5930F', 'surchargesPayment': '0', 'surchargesConversion': 0, 'payPercentBeforePlacingIntoProduction': 100, 'isEndUserPQ': False, 'purchaseType': '121B015A-E76D-4688-9BB6-2A56EC6DE2EF', 'finalBuyerId': 'e55f3bae-ef45-43bd-b2f6-9f0148ca5622', 'customerId': 'acb8f425-c3b6-4b38-9f34-1e7fbfd53fa9', 'clientInn': '7705238125', 'autoAvailableForDistributor': None, 'currencySpecialFixation': True, 'setContractDiscounts': True, 'isExport': False, 'validDays': 14, 'sellerId': '20C340FE-6AFF-486F-B248-FD8DBE2C93CD', 'IsATOffer': False, 'autoFromEngSpec': False, 'isNew': True, 'extendedWarranty': {'type': '0'}, 'priceFixingCorridorValue': None, 'isEstimateOffer': False, 'offerType': None, 'regionsValidityAT': None, 'deliveryOptionsDZRProd_override': {'ConsigneeCode': None, 'Condition': 'RU', 'DeliveryCost': 0, 'ClientFinalDelivery': None, 'ConsigneeContacts': None, 'consigneeAgreementDelivery': {'SourceFiasId': '00000000-0000-0000-0000-000000000000', 'Address': '', 'PaidDelivery': False, 'ConditionDescription': 'Стандартные договорные условия', 'INN': '6167138751'}, 'CostIncludedInOrder': False, 'totalDeliveryWeight': 40.85, 'endPoint': 'ToTK', 'deliveryType': 'PickupDZR', 'consigneeId': '00000000-0000-0000-0000-000000000000', 'deliverFullSetOnly': False}, 'userComment': 'ТЕСТ флоу методов - UpdateOffer'}
================================================================================

UPDATE OFFER RESPONSE
{'objects': [{'status': True}], 'status': 'Ok', 'messages': []}
✓ UpdateOffer успешно выполнен!
URL FullCommerceNew - https://ruecom-intru-tst.ridancorp.net/dapi/api/CrmCommerce/FullCommerceNew?requestId=83353a6d-6b02-4f5d-46c2-08de1d00de21
FULL COMMERCE NEW RESPONSE (после UpdateOffer)
{'objects': [{'data': [{'delayedDeliveryDiscountValue': 0.0, 'purchaseType': {'allowPartial': True, 'id': '121b015a-e76d-4688-9bb6-2a56ec6de2ef', 'value': 'Частичная закупка'}, 'paymentSchedule': None, 'completeDeliveryFrom': None, 'paidStorages': None, 'payPercentBeforePlacingIntoProduction': 100, 'filesPO': [], 'filesSA5': [], 'filesSA': [], 'files': [], 'termDate': '2025-11-20T23:59:59', 'sapAuthorPersonNumber': None, 'sapCodeDelivery': None, 'crmPassportNumber': 1193176, 'passportId': '8be18628-2e23-4650-a438-482484e0b64d', 'passportResponsiblePhone': '+7 (985) 266-93-35', 'passportResponsibleName': 'Анисимов Александр', 'passportResponsibleEmail': 'anisimov@ridan.ru', 'passportResponsibleNumber': '00001683', 'endClientOrderInitiator': None, 'specificationTitle': 'Тепловой Пункт/Котельная', 'markupPercentResult': None, 'markupResult': 0.0, 'euroRateOffer': 98.054, 'clientBroughtAmountResult': 153370.848, 'currencyDate': '2025-11-05T00:00:00', 'syncDate': None, 'currency': 'RUB', 'vaTcoef': 1.2, 'vaTperc': 20, 'isEndUserPQ': False, 'vaTresult': 25561.809, 'totalVat': 153370.854, 'total': 127809.045, 'validDate': '2025-11-20T14:42:35.733', 'validDays': 14, 'totalDistrDiscountPrice': 153370.854, 'salesPrice': 284020.1, 'objectCity': None, 'objectAddress': 'г Москва, ул Арбат, д 1', 'objectNumber': 1193176, 'objectName': 'test.092025', 'orders': None, 'debtorAccount': 'RT25-7705238125-HE', 'payerDisplay': 'фирма "ВОДОКОМФОРТ" (Офис Москва)', 'payerId': 'acb8f425-c3b6-4b38-9f34-1e7fbfd53fa9', 'paymentTerm': {'code': 'RU00', 'text': 'Предоплата', 'creditDays': 0, 'prepayPercent': 100}, 'endUserClientPerson': None, 'endUserClientId': None, 'endUserClient': 'ООО "ЭНТЕЗА"', 'createDate': '2025-11-06T14:42:32.353', 'commerceNumber': 'CLH04776935', 'deliveryShortInfo': 'Доставка, со склада в дер. Лешково, Истринский р-на (Московская обл.)  до  (Доставка до терминала, Бесплатно)', 'deliveryCondition': None, 'statusDisplay': 'Готов', 'status': '68c12a88-973a-4f7f-88aa-4242a1f81f40', 'surchargesPayment': 0.0, 'surchargesConvertation': 0.0, 'partialPurchase': True, 'crmCommerceId': '83353a6d-6b02-4f5d-46c2-08de1d00de21', 'salesOffice': 'Москва', 'finalClientInn': '6167138751', 'payerInn': '7705238125', 'deliveryOptions': {'consigneeCode': None, 'condition': None, 'mode': None, 'deliveryType': 'Contract', 'materialType': 'regularCodesMSK', 'deliveryCost': 0, 'deliveryCostInOrderCurrency': 0, 'totalDeliveryWeight': 0, 'comment': None, 'consigneeAgreementDelivery': None, 'clientFinalDelivery': None, 'consigneeContacts': None, 'endPoint': None, 'desiredDeliveryDate': None, 'deliverFullSetOnly': False, 'costIncludedInOrder': False, 'consigneeId': None}, 'deliveryOptionsHex': None, 'deliveryOptionsProd': None, 'deliveryOptionsDZRProd': {'consigneeCode': None, 'condition': 'RU', 'mode': None, 'deliveryType': 'PickupDZR', 'materialType': 'regularCodesMSK', 'deliveryCost': 0, 'deliveryCostInOrderCurrency': 0, 'totalDeliveryWeight': 40.85, 'comment': None, 'consigneeAgreementDelivery': {'conditionDescription': 'Стандартные договорные условия', 'inn': '6167138751', 'kpp': None, 'sourceFiasId': '00000000-0000-0000-0000-000000000000', 'destinationFiasId': None, 'destinationRegionFiasId': None, 'address': '', 'paidDelivery': False}, 'clientFinalDelivery': None, 'consigneeContacts': None, 'endPoint': 'ToTK', 'desiredDeliveryDate': None, 'deliverFullSetOnly': False, 'costIncludedInOrder': False, 'consigneeId': '00000000-0000-0000-0000-000000000000'}, 'availableForDistributor': True, 'isOrder': False, 'isValid': True, 'isITPsuccess': False, 'creatorUserId': '770b060c-4a2f-4638-adbb-dfbeb1813754', 'creatorPersonId': 'f8eaae4a-1309-4b24-95e8-3a092dc30067', 'creatorDisplay': 'Баженов Дмитрий Евгеньевич', 'orderNumber': None, 'sapReferenceNumber': None, 'approvementDeclined': False, 'distrApprovement': None, 'endClientOrderCreator': {'personId': 'f8eaae4a-1309-4b24-95e8-3a092dc30067', 'email': 'bazhenov_d@ridan.ru', 'phone': '+7 (962) 511-14-45', 'name': 'Ридан'}, 'autoDistrDiscount': 50.0, 'autoFromEngSpec': False, 'finalBayerId': 'e55f3bae-ef45-43bd-b2f6-9f0148ca5622', 'factPaymentPercent': 0.0, 'extendedWarranty': {'type': 'None', 'paymentType': 'None', 'invoiceType': 'None'}, 'isPinnedFinalBuyer': False, 'reservationEnd': None, 'autoClientDiscount': 42.0, 'comments': [], 'endUserPQStatusId': None, 'endUserPQDescription': None, 'confirmTimeByDistr': None, 'responseTimeClient': None, 'opportunityId': '09f15189-474d-4fa3-ac0f-478e289d9f32', 'finalBuyerCDLId': None, 'offerType': 'CLH', 'offerFlags': [], 'showPriceWithDiscount': True, 'showDiscount': False, 'source': None, 'oneCCurrentStatus': None, 'clientPersonId': None, 'deliveryTerms': None, 'deliveryTermsPTO': None}], 'details': [{'fromMoscow': False, 'weight': 40.85, 'packageSize': -1, 'ptoReadyForShipmentValue': None, 'islBox': False, 'isBTP': False, 'isPTO': True, 'isTDU': False, 'lineType': 'HEX', 'markupPercentResult': 0.0, 'markupResult': None, 'priceGroup': 'YA', 'totalVAT': 153370.854, 'total': 127809.045, 'vaTresult': 25561.809, 'retailPriceResultNoNDS': 284020.1, 'retailPriceResult': 340824.12, 'discount': 0, 'currency': 'RUB', 'salesPrice': 63904.5225, 'clientSalesPrice': 63904.5225, 'text': 'Аппарат теплообменный CLH32S', 'code': 'w003013006', 'materialCode': None, 'qty': 2.0, 'id': 'e72c1085-b11e-44e1-ac34-502ee460b752', 'item': 1, 'hexNumber': 'w003013006', 'btpNumber': None, 'warrantyTotal': 0.0, 'clientDiscountPercent': 55.0, 'clientBroughtAmountResult': 153370.848, 'availableForOrder': 2.0, 'deliveredCount': 0, 'stockCount': 0, 'packagedCount': 0, 'notPayedCount': 0, 'transit': None, 'isCanceled': False, 'canceledQuantity': 0, 'cancelReason': None, 'isSpecialPrice': False, 'bomSet': None, 'organization': {'contractorId': '20c340fe-6aff-486f-b248-fd8dbe2c93cd', 'inn': '5017132318', 'contractorName': 'ООО "РИДАН ТРЕЙД"', 'approvers': []}, 'shippedAt': None, 'applyedPromo': {'currencyValue': 115.0, 'name': 'Специальное правило расчёта. Применён курс 115 руб., при расчёте стоимости по прайсу.'}, 'invoiceNumber': None, 'invoiceDate': None, 'warehouse': None, 'isExclusiveBTP': False}], 'permissions': {'edit': False, 'moveToDraft': False, 'delete': False, 'addComment': False, 'addFile': False, 'getFile': False}}], 'status': 'Ok', 'messages': []}

Проверка количества для w003013006:
  Ожидаем: 2
  Получили: 2.0
✓ Количество корректно!

Проверка скидки для w003013006:
  Ожидаем: 55%
  Получили: 55.0%
✓ Скидка корректна!

================================================================================
ПРОВЕРКА ПОЛЕЙ ПОСЛЕ UpdateOffer → FullCommerceNew
================================================================================

 materialCode: ожидаем 'w003013006', получили 'w003013006'
 quantity: ожидаем 2, получили 2.0
 discount: ожидаем 55%, получили 55.0%
 currency: ожидаем 'RUB', получили 'RUB'
 debtorAccount: ожидаем 'RT25-7705238125-HE', получили 'RT25-7705238125-HE'
 personId: ожидаем 'f8eaae4a-1309-4b24-95e8-3a092dc30067', получили 'f8eaae4a-1309-4b24-95e8-3a092dc30067'
 lineType: ожидаем 'HEX', получили 'HEX'
 INN: ожидаем '6167138751', получили '6167138751'
 weight: ожидаем 40.85, получили 40.85

 Все поля после UpdateOffer корректны!
================================================================================

✓ Все изменения успешно применились!
Найдено 1 позиций в details
Mapping: w003013006 → e72c1085-b11e-44e1-ac34-502ee460b752
Contractor: w003013006 → 20c340fe-6aff-486f-b248-fd8dbe2c93cd
✓ Updated ODID for w003013006: e72c1085-b11e-44e1-ac34-502ee460b752
✓ Updated contractorId for w003013006: 20c340fe-6aff-486f-b248-fd8dbe2c93cd
ORDER CREATE PAYLOAD
{'orderLines': [{'materialCode': 'w003013006', 'quantity': 2, 'lineNumber': 1, 'lineType': 'HEX', 'odid': 'e72c1085-b11e-44e1-ac34-502ee460b752', 'deliveryDate': '2025-11-16T14:42:31.2911646+03:00', 'contractorId': '20c340fe-6aff-486f-b248-fd8dbe2c93cd', 'discountPercent': 55, 'endClientDiscountPercent': 55}], 'isEndUserPQ': False, 'docType': 'Quotation', 'authorNumber': '0000612383', 'currencyDate': None, 'exchangeRateType': None, 'projectDiscountConditions': False, 'debtorAccount': 'RT25-7705238125-HE', 'finalBuyerCDLId': None, 'clientInn': None, 'userComment': 'ТЕСТ флоу методов - Order/Create', 'engineerComment': '', 'currency': 'RUB', 'methodCode': 'ZWEB', 'purchaseDate': '2024-09-27T12:18:27+03:00', 'delayedDeliveryDiscountValue': None, 'personId': '920bb836-8ee4-4571-b5bd-94bd28c29d32', 'offerId': '83353a6d-6b02-4f5d-46c2-08de1d00de21', 'passportId': None, 'opportunityId': None, 'specTypeId': None, 'specificationId': None, 'salesGroup': 'RU1', 'salesOffice': 'RU01', 'referenceNumber': 'Z0000052452', 'paymentTerms': 'RU00', 'isDraft': False, 'purchaseType': None, 'finalBuyerId': None, 'availableForDistributor': False, 'autoAvailableForDistributor': None, 'payPercentComponentsBTP': None, 'payPercentBeforePlacingIntoProduction': None, 'customerId': None, 'isCLHOffer': False, 'deliveryOptionsHex': None, 'deliveryOptionsProd': None, 'deliveryOptionsDZRProd': {'ConsigneeCode': None, 'Condition': 'RU', 'DeliveryCost': 0, 'ClientFinalDelivery': None, 'ConsigneeContacts': None, 'consigneeAgreementDelivery': {'SourceFiasId': '00000000-0000-0000-0000-000000000000', 'Address': '', 'PaidDelivery': False, 'ConditionDescription': 'Стандартные договорные условия', 'INN': '6167138751'}, 'CostIncludedInOrder': False, 'totalDeliveryWeight': 40.85, 'endPoint': 'ToTK', 'deliveryType': 'PickupDZR', 'consigneeId': '00000000-0000-0000-0000-000000000000', 'deliverFullSetOnly': False}, 'deliveryNotificationSettings': None, 'projectObject': {'id': '8BE18628-2E23-4650-A438-482484E0B64D', 'name': 'Детский сад на 240 мест в г. Тарко-Сале, мкр.Южный', 'address': 'Ямало-Ненецкий АО, г Тарко-Сале, мкр Южный', 'number': 1178586, 'comment': ' '}, 'setContractDiscounts': False, 'currencySpecialFixation': False, 'extendValidit': 0, 'showPriceWithDiscount': False, 'showDiscount': False, 'finalMarkup': None, 'surchargesPayment': None, 'surchargesConversion': None, 'recommendedDistributors': []}
ORDER CREATE RESPONSE
{'objects': [{'id': '69daf3a7-2eaf-43aa-46c3-08de1d00de21', 'docNumber': 'CLH04776935', 'referenceNumber': None, 'hexReferenceNumbers': ['CLH04776935-1'], 'offer': {'offerId': '83353a6d-6b02-4f5d-46c2-08de1d00de21', 'offerNumber': 'CLH04776935'}, 'orders': [{'orderNumber': None, 'orderType': 'HEX', 'offerId': '69daf3a7-2eaf-43aa-46c3-08de1d00de21', 'offerNumber': 'CLH04776935-1'}]}], 'status': 'Ok', 'messages': []}
Тест успешно выполнен! Весь цикл с UpdateOffer завершен.
PASSED
=== Running test for: Industrial HEX code - FROM ORGANIZATION ===
SIMULATE RESPONSE
{'objects': [{'orderLines': [{'bomLines': [], 'schedules': [{'lineNumber': 1, 'confirmedQuantity': 1, 'correctedQuantity': 1, 'orderedQuantity': 1, 'deliveryDate': '2025-11-09T14:42:41.2608339+03:00', 'correctedDeliveryDate': '3 раб.дн.', 'scheduleType': 'Transit'}], 'odid': None, 'copiedFromId': None, 'lineNumber': 1, 'hasPromo': False, 'sourceLineNumber': 1, 'materialCode': 'w202102975', 'altMaterialCode': 'w202102975', 'description': 'Аппарат теплообменный пластинчатый разборный НН№14', 'descriptionExtended': None, 'salesPrice': 270713.79, 'warrantyPrice': 0, 'width': 0, 'weight': 154.26, 'orderedQuantity': 1, 'availableQuantity': 0, 'transitQuantity': 1, 'confirmedDeliveryDate': '2025-11-09T14:42:41.2608339+03:00', 'deliveryTimeStandard': '', 'surchargesPrice': 270713.79, 'surchargesPercent': 0, 'tax': 54142.758, 'discount': 0, 'discountPercent': 0, 'corridorCooficient': None, 'clientDiscountPercent': 0, 'distrDiscountPercent': 0, 'distrContractDiscount': 0, 'distrMaxDiscount': 0, 'approvedDiscount': None, 'currency': 'RUB', 'cost': 39696.31, 'costCurrency': 'RUB', 'salesPriceWithTax': 324856.548, 'comments': [], 'category': None, 'statuses': [], 'lineType': 'HEX', 'mpg': 'YA', 'areaActivity': {'id': 'aff0fafb-0e4e-11ed-9528-5254008cf63f', 'description': 'Теплоавтоматика РФ'}, 'gfu': {'id': '890603f9-0890-4839-0625-08dbf7c34296', 'description': '43 Готовая продукция'}, 'materialSubType': None, 'availability': {'requestedQty': 1, 'onStockQty': 0, 'transit': [{'quantity': 1, 'date': '2025-11-09T14:42:41.2608339+03:00', 'documentType': 'OrderedByDistributor'}], 'onTransitQty': 1, 'transitDate': '2025-11-09T14:42:41.2608339+03:00', 'notAvailableQty': 0, 'deliveryWeeks': 1, 'deliveryDays': 3, 'deliveryTimeStandard': '3 рабочих дня'}, 'isSpecialPrice': False, 'isCorrectedQuantity': False, 'allowCreateDueDeliveryTicket': False, 'isZeroPrices': False, 'lockCode': None, 'isManufactureReserved': False, 'equipmentCategoryId': '52550619-62b2-4aaf-82ab-8ca26830ec7f', 'equipmentCategory': 'Теплообменник', 'packageSize': 0, 'promoCurrencyValue': 0, 'autoDistrPosDiscount': 0, 'autoClientPosDiscount': 0, 'excludePosition': False, 'sourcePrice': None, 'specialPrice': None, 'tenderAmount': None, 'calc': {'id': '62bc160b-1a4b-4b79-ba56-7ca59c3014d8', 'number': 'w202102975', 'materialCode': None, 'calcType': 'HEX', 'assembleTimeCost': 39.08}}], 'orderParty': {'currency': 'RUB', 'customerGroup': None, 'debtorAccount': '31/25-CH', 'deliveryAddress': None, 'deliveryMode': None, 'deliveryPlant': None, 'paymentTerms': 'RU00', 'salesGroup': '', 'salesOffice': '', 'exchangeRate': 97.3157, 'deliveryModeText': None, 'deliveryPlantName': None, 'salesOfficeText': '', 'salesGroupText': '', 'paymentTermsText': '', 'currencyDate': '2025-10-15T00:00:00', 'exchangeRateType': 'YRU'}, 'deliveryReceivers': [], 'itPtips': None, 'discountTips': None, 'discountTip': None, 'volumeDiscountTips': [], 'kitDiscountTips': [], 'authoPriceResults': None, 'sourceTenderOffer': None}], 'status': 'Ok', 'messages': []}
Исходное количество из Simulate: 1
Order lines from Simulate: [{'materialCode': 'w202102975', 'quantity': 1, 'lineNumber': 1, 'lineType': 'HEX', 'odid': None, 'deliveryDate': '2025-11-09T14:42:41.2608339+03:00'}]

================================================================================
CREATE OFFER PAYLOAD (что отправляем):
{'source': None, 'currency': 'RUB', 'exchangeRateType': 'YRU', 'debtorAccount': '31/25-CH', 'personId': 'b898f86a-6070-451b-9a14-47ba949c8cb8', 'paymentTerms': 'RU00', 'orderLines': [{'materialCode': 'w202102975', 'quantity': 1, 'lineNumber': 1, 'lineType': 'HEX', 'odid': None, 'deliveryDate': '2025-11-09T14:42:41.2608339+03:00'}], 'isDraft': True, 'deliveryOptionsDZRProd': {'ConsigneeCode': None, 'Condition': 'RU', 'DeliveryCost': 0, 'ClientFinalDelivery': None, 'ConsigneeContacts': None, 'consigneeAgreementDelivery': {'SourceFiasId': '00000000-0000-0000-0000-000000000000', 'Address': '', 'PaidDelivery': False, 'ConditionDescription': 'Стандартные договорные условия', 'INN': '5249173547'}, 'CostIncludedInOrder': False, 'totalDeliveryWeight': 1262.56, 'endPoint': 'ToTK', 'deliveryType': 'PickupDZR', 'consigneeId': '00000000-0000-0000-0000-000000000000', 'deliverFullSetOnly': False}, 'projectObject': {'id': '9abbcb6b-91ac-4d69-bbee-d0d0f583e18d', 'name': 'Детский сад на 240 мест в г. Тарко-Сале, мкр.Южный', 'address': 'Ямало-Ненецкий АО, г Тарко-Сале, мкр Южный', 'number': 1178586, 'comment': ' '}, 'docType': 'Order', 'showPriceWithDiscount': False, 'showDiscount': True, 'currencyDate': '2025-10-15T00:00:00', 'userName': 'RUCO1845', 'usePromoCurrency': False, 'opportunityId': 'CF0F3885-3CA5-409D-A270-5E82E6EFD02C', 'surchargesPayment': '0', 'surchargesConversion': 0, 'payPercentBeforePlacingIntoProduction': 100, 'isEndUserPQ': False, 'purchaseType': '121B015A-E76D-4688-9BB6-2A56EC6DE2EF', 'finalBuyerId': 'BF2FE82C-FED9-414B-9BA3-403CE76C9000', 'customerId': 'BF2FE82C-FED9-414B-9BA3-403CE76C9000', 'clientInn': '5249173547', 'autoAvailableForDistributor': None, 'currencySpecialFixation': True, 'setContractDiscounts': True, 'isExport': False, 'validDays': 3, 'sellerId': '20C340FE-6AFF-486F-B248-FD8DBE2C93CD', 'IsATOffer': False, 'autoFromEngSpec': False, 'isNew': True, 'extendedWarranty': {'type': '0'}, 'priceFixingCorridorValue': None, 'isEstimateOffer': False, 'offerType': None, 'passportId': '9abbcb6b-91ac-4d69-bbee-d0d0f583e18d', 'specificationId': 'ece5153c-fbbd-4b55-816e-e7dd035364ad', 'userComment': 'ТЕСТ флоу методов Industrial - CreateOffer'}
================================================================================

CREATE OFFER RESPONSE
{'objects': [{'lines': [{'remark': None, 'avaliability': [], 'bomSet': None, 'salesPrice': 319908.15, 'cost': None, 'costCurrency': None, 'quantity': 1, 'description': 'Аппарат теплообменный пластинчатый разборный НН№14', 'code': 'w202102975', 'altMaterialCode': None, 'totalWithDiscountSurchargesAndVAT': 383889.78, 'totalWithDiscountAndSurcharges': None, 'totalWithDiscount': None, 'surchargesDelayPercent': None, 'surchargesCurrencyConversionPercent': None, 'discountAmount': None, 'discountPercent': 0, 'weight': None, 'deliveryWeeks': 0, 'calcNumber': None, 'calculationComment': None, 'comment': None, 'isSpecial': 0, 'isProtected': False, 'calcId': None, 'hexIsReady': False, 'clientDiscountPercent': None, 'clientBroughtAmountResult': None, 'itpDiscountPercent': None, 'contractDiscountPercent': None, 'sourceNOrder': 1, 'positionOrder': 1, 'warrantyTotal': None, 'salesPriceWithoutDiscount': 319908.15, 'totalWithoutDiscount': 319908.15, 'subType': 'Import', 'mpg': None, 'prodHierarchy': None, 'category': None, 'taxes': 0, 'abcCategory': None, 'equipmentCategoryId': None, 'equipmentCategory': None, 'surchargePercent': 0}], 'offers': [{'sapReferenceNumber': None, 'paymentTerms': None, 'exchangeRate': 0, 'deliveryPlant': None, 'deliveryMode': None, 'deliveryAddress': None, 'debtorAccount': None, 'currency': 'RUB', 'broughtAmountResult': 383889.78, 'number': 'IND04776936', 'id': '1efcd105-40ca-4df8-46c4-08de1d00de21', 'isITPsuccess': None, 'crmUrl': None, 'clientBroughtAmountResult': 0, 'pObjectName': None, 'pObjectNumber': None, 'specificationNumber': None, 'opportunityName': None}], 'invoices': None, 'errors': None, 'itPtips': None, 'createdOffers': None}], 'status': 'Ok', 'messages': []}
Created offer_id: 1efcd105-40ca-4df8-46c4-08de1d00de21, offer_number: IND04776936
URL FullCommerceNew - https://ruecom-intru-tst.ridancorp.net/dapi/api/CrmCommerce/FullCommerceNew?requestId=1efcd105-40ca-4df8-46c4-08de1d00de21
FULL COMMERCE NEW RESPONSE (до UpdateOffer)
{'objects': [{'data': [{'delayedDeliveryDiscountValue': 0.0, 'purchaseType': {'allowPartial': True, 'id': '121b015a-e76d-4688-9bb6-2a56ec6de2ef', 'value': 'Частичная закупка'}, 'paymentSchedule': None, 'completeDeliveryFrom': None, 'paidStorages': None, 'payPercentBeforePlacingIntoProduction': 100, 'filesPO': [], 'filesSA5': [], 'filesSA': [], 'files': [], 'termDate': None, 'sapAuthorPersonNumber': None, 'sapCodeDelivery': None, 'crmPassportNumber': None, 'passportId': None, 'passportResponsiblePhone': None, 'passportResponsibleName': 'Уточкин Евгений', 'passportResponsibleEmail': 'RUCO1903@ridan.ru', 'passportResponsibleNumber': '00001903', 'endClientOrderInitiator': None, 'specificationTitle': None, 'markupPercentResult': None, 'markupResult': 0.0, 'euroRateOffer': 97.3157, 'clientBroughtAmountResult': 383889.78, 'currencyDate': '2025-10-15T00:00:00', 'syncDate': None, 'currency': 'RUB', 'vaTcoef': 1.2, 'vaTperc': 20, 'isEndUserPQ': False, 'vaTresult': 63981.63, 'totalVat': 383889.78, 'total': 319908.15, 'validDate': '2025-11-09T14:42:42.067', 'validDays': 3, 'totalDistrDiscountPrice': 383889.78, 'salesPrice': 319908.15, 'objectCity': None, 'objectAddress': None, 'objectNumber': None, 'objectName': 'сделка_750039_15102025140447', 'orders': None, 'debtorAccount': '31/25-CH', 'payerDisplay': 'ООО "СИНТЕЗ ОКА-ПОЛИЭФИР"', 'payerId': 'bf2fe82c-fed9-414b-9ba3-403ce76c9000', 'paymentTerm': {'code': 'RU00', 'text': 'Предоплата', 'creditDays': 0, 'prepayPercent': 100}, 'endUserClientPerson': None, 'endUserClientId': None, 'endUserClient': 'ООО "СИНТЕЗ ОКА-ПОЛИЭФИР"', 'createDate': '2025-11-06T14:42:42.067', 'commerceNumber': 'IND04776936', 'deliveryShortInfo': 'Доставка, со склада в дер. Лешково, Истринский р-на (Московская обл.)  до  (Доставка до терминала, Бесплатно)', 'deliveryCondition': None, 'statusDisplay': 'Черновик', 'status': '5d6f1a5d-3254-44e5-97d7-c4d20f440b61', 'surchargesPayment': 0.0, 'surchargesConvertation': 0.0, 'partialPurchase': True, 'crmCommerceId': '1efcd105-40ca-4df8-46c4-08de1d00de21', 'salesOffice': 'Нижний Новгород', 'finalClientInn': '5249173547', 'payerInn': '5249173547', 'deliveryOptions': {'consigneeCode': None, 'condition': None, 'mode': None, 'deliveryType': 'Contract', 'materialType': 'regularCodesMSK', 'deliveryCost': 0, 'deliveryCostInOrderCurrency': 0, 'totalDeliveryWeight': 0, 'comment': None, 'consigneeAgreementDelivery': None, 'clientFinalDelivery': None, 'consigneeContacts': None, 'endPoint': None, 'desiredDeliveryDate': None, 'deliverFullSetOnly': False, 'costIncludedInOrder': False, 'consigneeId': None}, 'deliveryOptionsHex': None, 'deliveryOptionsProd': None, 'deliveryOptionsDZRProd': {'consigneeCode': None, 'condition': 'RU', 'mode': None, 'deliveryType': 'PickupDZR', 'materialType': 'regularCodesMSK', 'deliveryCost': 0, 'deliveryCostInOrderCurrency': 0, 'totalDeliveryWeight': 1262.56, 'comment': None, 'consigneeAgreementDelivery': {'conditionDescription': 'Стандартные договорные условия', 'inn': '5249173547', 'kpp': None, 'sourceFiasId': '00000000-0000-0000-0000-000000000000', 'destinationFiasId': None, 'destinationRegionFiasId': None, 'address': '', 'paidDelivery': False}, 'clientFinalDelivery': None, 'consigneeContacts': None, 'endPoint': 'ToTK', 'desiredDeliveryDate': None, 'deliverFullSetOnly': False, 'costIncludedInOrder': False, 'consigneeId': '00000000-0000-0000-0000-000000000000'}, 'availableForDistributor': False, 'isOrder': False, 'isValid': True, 'isITPsuccess': False, 'creatorUserId': 'eec1e544-e30e-45a7-a4ba-87e922547968', 'creatorPersonId': 'b898f86a-6070-451b-9a14-47ba949c8cb8', 'creatorDisplay': 'Виноградов Егор', 'orderNumber': None, 'sapReferenceNumber': None, 'approvementDeclined': False, 'distrApprovement': None, 'endClientOrderCreator': {'personId': 'b898f86a-6070-451b-9a14-47ba949c8cb8', 'email': 'vinogradov_e@ridan.ru', 'phone': None, 'name': 'Ридан'}, 'autoDistrDiscount': None, 'autoFromEngSpec': False, 'finalBayerId': 'bf2fe82c-fed9-414b-9ba3-403ce76c9000', 'factPaymentPercent': 0.0, 'extendedWarranty': {'type': 'None', 'paymentType': 'None', 'invoiceType': 'None'}, 'isPinnedFinalBuyer': False, 'reservationEnd': None, 'autoClientDiscount': None, 'comments': [], 'endUserPQStatusId': None, 'endUserPQDescription': None, 'confirmTimeByDistr': None, 'responseTimeClient': None, 'opportunityId': 'cf0f3885-3ca5-409d-a270-5e82e6efd02c', 'finalBuyerCDLId': None, 'offerType': 'IND', 'offerFlags': [], 'showPriceWithDiscount': False, 'showDiscount': True, 'source': None, 'oneCCurrentStatus': None, 'clientPersonId': None, 'deliveryTerms': None, 'deliveryTermsPTO': None}], 'details': [{'fromMoscow': False, 'weight': 154.26, 'packageSize': -1, 'ptoReadyForShipmentValue': None, 'islBox': False, 'isBTP': False, 'isPTO': True, 'isTDU': False, 'lineType': 'HEX', 'markupPercentResult': 0.0, 'markupResult': None, 'priceGroup': 'YA', 'totalVAT': 383889.78, 'total': 319908.15, 'vaTresult': 63981.63, 'retailPriceResultNoNDS': 319908.15, 'retailPriceResult': 383889.78, 'discount': 0.0, 'currency': 'RUB', 'salesPrice': 319908.15, 'clientSalesPrice': 319908.15, 'text': 'Аппарат теплообменный пластинчатый разборный НН№14', 'code': 'w202102975', 'materialCode': None, 'qty': 1.0, 'id': '07feb769-9e12-4415-9cfa-cc9b6af3a669', 'item': 1, 'hexNumber': 'w202102975', 'btpNumber': None, 'warrantyTotal': 0.0, 'clientDiscountPercent': None, 'clientBroughtAmountResult': 383889.78, 'availableForOrder': 1.0, 'deliveredCount': 0, 'stockCount': 0, 'packagedCount': 0, 'notPayedCount': 0, 'transit': None, 'isCanceled': False, 'canceledQuantity': 0, 'cancelReason': None, 'isSpecialPrice': False, 'bomSet': None, 'organization': {'contractorId': '20c340fe-6aff-486f-b248-fd8dbe2c93cd', 'inn': '5017132318', 'contractorName': 'ООО "РИДАН ТРЕЙД"', 'approvers': []}, 'shippedAt': None, 'applyedPromo': {'currencyValue': 115.0, 'name': 'Специальное правило расчёта. Применён курс 115 руб., при расчёте стоимости по прайсу.'}, 'invoiceNumber': None, 'invoiceDate': None, 'warehouse': None, 'isExclusiveBTP': False}], 'permissions': {'edit': False, 'moveToDraft': False, 'delete': False, 'addComment': False, 'addFile': False, 'getFile': False}}], 'status': 'Ok', 'messages': []}
Найдено 1 позиций в details
Mapping: w202102975 → 07feb769-9e12-4415-9cfa-cc9b6af3a669
Contractor: w202102975 → 20c340fe-6aff-486f-b248-fd8dbe2c93cd
✓ Updated ODID for w202102975: 07feb769-9e12-4415-9cfa-cc9b6af3a669
✓ Updated contractorId for w202102975: 20c340fe-6aff-486f-b248-fd8dbe2c93cd
Updated order lines with ODID: [{'materialCode': 'w202102975', 'quantity': 1, 'lineNumber': 1, 'lineType': 'HEX', 'odid': '07feb769-9e12-4415-9cfa-cc9b6af3a669', 'deliveryDate': '2025-11-09T14:42:41.2608339+03:00', 'contractorId': '20c340fe-6aff-486f-b248-fd8dbe2c93cd'}]

  Ожидаем lineType: 'HEX'
  Получили lineType: 'HEX'
  lineType корректен: 'HEX'

================================================================================
ПРОВЕРКА СТАНДАРТНЫХ ПОЛЕЙ ПОСЛЕ CreateOffer → FullCommerceNew
================================================================================

 materialCode: ожидаем 'w202102975', получили 'w202102975'
 quantity: ожидаем 1, получили 1.0
 currency: ожидаем 'RUB', получили 'RUB'
 debtorAccount: ожидаем '31/25-CH', получили '31/25-CH'
 personId: ожидаем 'b898f86a-6070-451b-9a14-47ba949c8cb8', получили 'b898f86a-6070-451b-9a14-47ba949c8cb8'

 Все стандартные поля корректны!
================================================================================

Original Seller ID: 20c340fe-6aff-486f-b248-fd8dbe2c93cd
Original Contractor Name: ООО "РИДАН ТРЕЙД"
OpportunityId из FullCommerceNew: cf0f3885-3ca5-409d-a270-5e82e6efd02c

================================================================================
UPDATE OFFER PAYLOAD (что отправляем):
{'source': None, 'currency': 'RUB', 'exchangeRateType': 'YRU', 'debtorAccount': '31/25-CH', 'personId': 'b898f86a-6070-451b-9a14-47ba949c8cb8', 'paymentTerms': 'RU00', 'offerId': '1efcd105-40ca-4df8-46c4-08de1d00de21', 'opportunityId': 'CF0F3885-3CA5-409D-A270-5E82E6EFD02C', 'orderLines': [{'materialCode': 'w202102975', 'quantity': 2, 'lineNumber': 1, 'lineType': 'HEX', 'odid': '07feb769-9e12-4415-9cfa-cc9b6af3a669', 'deliveryDate': '2025-11-09T14:42:41.2608339+03:00', 'contractorId': '20c340fe-6aff-486f-b248-fd8dbe2c93cd', 'discountPercent': 0, 'endClientDiscountPercent': 0}], 'isDraft': False, 'deliveryOptionsDZRProd': {'ConsigneeCode': None, 'Condition': 'RU', 'DeliveryCost': 0, 'ClientFinalDelivery': None, 'ConsigneeContacts': None, 'consigneeAgreementDelivery': {'SourceFiasId': '00000000-0000-0000-0000-000000000000', 'Address': '', 'PaidDelivery': False, 'ConditionDescription': 'Стандартные договорные условия', 'INN': '5249173547'}, 'CostIncludedInOrder': False, 'totalDeliveryWeight': 1262.56, 'endPoint': 'ToTK', 'deliveryType': 'PickupDZR', 'consigneeId': '00000000-0000-0000-0000-000000000000', 'deliverFullSetOnly': False}, 'projectObject': {'id': '9abbcb6b-91ac-4d69-bbee-d0d0f583e18d', 'name': 'Детский сад на 240 мест в г. Тарко-Сале, мкр.Южный', 'address': 'Ямало-Ненецкий АО, г Тарко-Сале, мкр Южный', 'number': 1178586, 'comment': ' '}, 'docType': 'Order', 'showPriceWithDiscount': False, 'showDiscount': True, 'currencyDate': '2025-10-15T00:00:00', 'userName': 'RUCO1845', 'usePromoCurrency': False, 'surchargesPayment': '0', 'surchargesConversion': 0, 'payPercentBeforePlacingIntoProduction': 100, 'isEndUserPQ': False, 'purchaseType': '121B015A-E76D-4688-9BB6-2A56EC6DE2EF', 'finalBuyerId': 'BF2FE82C-FED9-414B-9BA3-403CE76C9000', 'customerId': 'BF2FE82C-FED9-414B-9BA3-403CE76C9000', 'clientInn': '5249173547', 'autoAvailableForDistributor': None, 'currencySpecialFixation': True, 'setContractDiscounts': True, 'isExport': False, 'validDays': 3, 'sellerId': '20C340FE-6AFF-486F-B248-FD8DBE2C93CD', 'IsATOffer': False, 'autoFromEngSpec': False, 'extendedWarranty': {'type': '0'}, 'priceFixingCorridorValue': None, 'isEstimateOffer': False, 'offerType': None, 'passportId': '9abbcb6b-91ac-4d69-bbee-d0d0f583e18d', 'specificationId': 'ece5153c-fbbd-4b55-816e-e7dd035364ad', 'userComment': 'ТЕСТ флоу методов Industrial - UpdateOffer'}
================================================================================

UPDATE OFFER RESPONSE
{'objects': [{'status': True}], 'status': 'Ok', 'messages': []}
✓ UpdateOffer успешно выполнен!
URL FullCommerceNew - https://ruecom-intru-tst.ridancorp.net/dapi/api/CrmCommerce/FullCommerceNew?requestId=1efcd105-40ca-4df8-46c4-08de1d00de21
FULL COMMERCE NEW RESPONSE (после UpdateOffer)
{'objects': [{'data': [{'delayedDeliveryDiscountValue': 0.0, 'purchaseType': {'allowPartial': True, 'id': '121b015a-e76d-4688-9bb6-2a56ec6de2ef', 'value': 'Частичная закупка'}, 'paymentSchedule': None, 'completeDeliveryFrom': None, 'paidStorages': None, 'payPercentBeforePlacingIntoProduction': 100, 'filesPO': [], 'filesSA5': [], 'filesSA': [], 'files': [], 'termDate': None, 'sapAuthorPersonNumber': None, 'sapCodeDelivery': None, 'crmPassportNumber': None, 'passportId': None, 'passportResponsiblePhone': None, 'passportResponsibleName': 'Уточкин Евгений', 'passportResponsibleEmail': 'RUCO1903@ridan.ru', 'passportResponsibleNumber': '00001903', 'endClientOrderInitiator': None, 'specificationTitle': None, 'markupPercentResult': None, 'markupResult': 0.0, 'euroRateOffer': 97.3157, 'clientBroughtAmountResult': 767779.56, 'currencyDate': '2025-10-15T00:00:00', 'syncDate': None, 'currency': 'RUB', 'vaTcoef': 1.2, 'vaTperc': 20, 'isEndUserPQ': False, 'vaTresult': 127963.26, 'totalVat': 767779.56, 'total': 639816.3, 'validDate': '2025-11-09T14:42:42.067', 'validDays': 3, 'totalDistrDiscountPrice': 767779.56, 'salesPrice': 639816.3, 'objectCity': None, 'objectAddress': None, 'objectNumber': None, 'objectName': 'сделка_750039_15102025140447', 'orders': None, 'debtorAccount': '31/25-CH', 'payerDisplay': 'ООО "СИНТЕЗ ОКА-ПОЛИЭФИР"', 'payerId': 'bf2fe82c-fed9-414b-9ba3-403ce76c9000', 'paymentTerm': {'code': 'RU00', 'text': 'Предоплата', 'creditDays': 0, 'prepayPercent': 100}, 'endUserClientPerson': None, 'endUserClientId': None, 'endUserClient': 'ООО "СИНТЕЗ ОКА-ПОЛИЭФИР"', 'createDate': '2025-11-06T14:42:42.067', 'commerceNumber': 'IND04776936', 'deliveryShortInfo': 'Доставка, со склада в дер. Лешково, Истринский р-на (Московская обл.)  до  (Доставка до терминала, Бесплатно)', 'deliveryCondition': None, 'statusDisplay': 'Согласование', 'status': 'a4f61a50-c5b3-475b-bc96-26045438f547', 'surchargesPayment': 0.0, 'surchargesConvertation': 0.0, 'partialPurchase': True, 'crmCommerceId': '1efcd105-40ca-4df8-46c4-08de1d00de21', 'salesOffice': 'Нижний Новгород', 'finalClientInn': '5249173547', 'payerInn': '5249173547', 'deliveryOptions': {'consigneeCode': None, 'condition': None, 'mode': None, 'deliveryType': 'Contract', 'materialType': 'regularCodesMSK', 'deliveryCost': 0, 'deliveryCostInOrderCurrency': 0, 'totalDeliveryWeight': 0, 'comment': None, 'consigneeAgreementDelivery': None, 'clientFinalDelivery': None, 'consigneeContacts': None, 'endPoint': None, 'desiredDeliveryDate': None, 'deliverFullSetOnly': False, 'costIncludedInOrder': False, 'consigneeId': None}, 'deliveryOptionsHex': None, 'deliveryOptionsProd': None, 'deliveryOptionsDZRProd': {'consigneeCode': None, 'condition': 'RU', 'mode': None, 'deliveryType': 'PickupDZR', 'materialType': 'regularCodesMSK', 'deliveryCost': 0, 'deliveryCostInOrderCurrency': 0, 'totalDeliveryWeight': 1262.56, 'comment': None, 'consigneeAgreementDelivery': {'conditionDescription': 'Стандартные договорные условия', 'inn': '5249173547', 'kpp': None, 'sourceFiasId': '00000000-0000-0000-0000-000000000000', 'destinationFiasId': None, 'destinationRegionFiasId': None, 'address': '', 'paidDelivery': False}, 'clientFinalDelivery': None, 'consigneeContacts': None, 'endPoint': 'ToTK', 'desiredDeliveryDate': None, 'deliverFullSetOnly': False, 'costIncludedInOrder': False, 'consigneeId': '00000000-0000-0000-0000-000000000000'}, 'availableForDistributor': False, 'isOrder': False, 'isValid': True, 'isITPsuccess': False, 'creatorUserId': 'eec1e544-e30e-45a7-a4ba-87e922547968', 'creatorPersonId': 'b898f86a-6070-451b-9a14-47ba949c8cb8', 'creatorDisplay': 'Виноградов Егор', 'orderNumber': None, 'sapReferenceNumber': None, 'approvementDeclined': False, 'distrApprovement': None, 'endClientOrderCreator': {'personId': 'b898f86a-6070-451b-9a14-47ba949c8cb8', 'email': 'vinogradov_e@ridan.ru', 'phone': None, 'name': 'Ридан'}, 'autoDistrDiscount': None, 'autoFromEngSpec': False, 'finalBayerId': 'bf2fe82c-fed9-414b-9ba3-403ce76c9000', 'factPaymentPercent': 0.0, 'extendedWarranty': {'type': 'None', 'paymentType': 'None', 'invoiceType': 'None'}, 'isPinnedFinalBuyer': False, 'reservationEnd': None, 'autoClientDiscount': None, 'comments': [], 'endUserPQStatusId': None, 'endUserPQDescription': None, 'confirmTimeByDistr': None, 'responseTimeClient': None, 'opportunityId': 'cf0f3885-3ca5-409d-a270-5e82e6efd02c', 'finalBuyerCDLId': None, 'offerType': 'IND', 'offerFlags': [], 'showPriceWithDiscount': False, 'showDiscount': True, 'source': None, 'oneCCurrentStatus': None, 'clientPersonId': None, 'deliveryTerms': None, 'deliveryTermsPTO': None}], 'details': [{'fromMoscow': False, 'weight': 154.26, 'packageSize': -1, 'ptoReadyForShipmentValue': None, 'islBox': False, 'isBTP': False, 'isPTO': True, 'isTDU': False, 'lineType': 'HEX', 'markupPercentResult': 0.0, 'markupResult': None, 'priceGroup': 'YA', 'totalVAT': 767779.56, 'total': 639816.3, 'vaTresult': 127963.26, 'retailPriceResultNoNDS': 639816.3, 'retailPriceResult': 767779.56, 'discount': 0.0, 'currency': 'RUB', 'salesPrice': 319908.15, 'clientSalesPrice': 319908.15, 'text': 'Аппарат теплообменный пластинчатый разборный НН№14', 'code': 'w202102975', 'materialCode': None, 'qty': 2.0, 'id': '07feb769-9e12-4415-9cfa-cc9b6af3a669', 'item': 1, 'hexNumber': 'w202102975', 'btpNumber': None, 'warrantyTotal': 0.0, 'clientDiscountPercent': 0.0, 'clientBroughtAmountResult': 767779.56, 'availableForOrder': 2.0, 'deliveredCount': 0, 'stockCount': 0, 'packagedCount': 0, 'notPayedCount': 0, 'transit': None, 'isCanceled': False, 'canceledQuantity': 0, 'cancelReason': None, 'isSpecialPrice': False, 'bomSet': None, 'organization': {'contractorId': '20c340fe-6aff-486f-b248-fd8dbe2c93cd', 'inn': '5017132318', 'contractorName': 'ООО "РИДАН ТРЕЙД"', 'approvers': []}, 'shippedAt': None, 'applyedPromo': {'currencyValue': 115.0, 'name': 'Специальное правило расчёта. Применён курс 115 руб., при расчёте стоимости по прайсу.'}, 'invoiceNumber': None, 'invoiceDate': None, 'warehouse': None, 'isExclusiveBTP': False}], 'permissions': {'edit': False, 'moveToDraft': False, 'delete': False, 'addComment': False, 'addFile': False, 'getFile': False}}], 'status': 'Ok', 'messages': []}

Проверка количества для w202102975:
  Ожидаем: 2
  Получили: 2.0
✓ Количество корректно!

Проверка скидки для w202102975:
  Ожидаем: 0%
  Получили: 0.0%
✓ Скидка корректна!

================================================================================
ПРОВЕРКА ПОЛЕЙ ПОСЛЕ UpdateOffer → FullCommerceNew
================================================================================

 materialCode: ожидаем 'w202102975', получили 'w202102975'
 quantity: ожидаем 2, получили 2.0
 discount: ожидаем 0%, получили 0.0%
 currency: ожидаем 'RUB', получили 'RUB'
 debtorAccount: ожидаем '31/25-CH', получили '31/25-CH'
 personId: ожидаем 'b898f86a-6070-451b-9a14-47ba949c8cb8', получили 'b898f86a-6070-451b-9a14-47ba949c8cb8'
 lineType: ожидаем 'HEX', получили 'HEX'

 Все поля после UpdateOffer корректны!
================================================================================

✓ Все изменения успешно применились!

Статус КП после UpdateOffer: Согласование
Order/Create НЕ выполняется - КП остается в статусе согласования

Тест успешно выполнен! (без Order/Create)
PASSED
test_simulate_to_create_offer_to_full_commerce_new_to_order_crate_flow.py::TestSimulateOfferUpdateOfferFullOrderE2E::test_industrial_chain_without_order[HR] 
=== Running test for: HR Radiator code - full flow with UpdateOffer ===
SIMULATE RESPONSE
{'objects': [{'orderLines': [{'bomLines': [], 'schedules': [{'lineNumber': 0, 'confirmedQuantity': 2, 'correctedQuantity': 2, 'orderedQuantity': 2, 'deliveryDate': None, 'correctedDeliveryDate': None, 'scheduleType': 'Unavailable'}], 'odid': None, 'copiedFromId': None, 'lineNumber': 0, 'hasPromo': False, 'sourceLineNumber': 0, 'materialCode': 'HR00045', 'altMaterialCode': 'HR00045', 'description': 'Радиатор стальной панельный тип 10 высота 500  длина 400 боковое подключение', 'descriptionExtended': None, 'salesPrice': 1547.76, 'warrantyPrice': 0, 'width': 0, 'weight': 0, 'orderedQuantity': 2, 'availableQuantity': 0, 'transitQuantity': 0, 'confirmedDeliveryDate': None, 'deliveryTimeStandard': '', 'surchargesPrice': 3095.52, 'surchargesPercent': 0.0, 'tax': 619.104, 'discount': 0, 'discountPercent': 0, 'corridorCooficient': None, 'clientDiscountPercent': 0, 'distrDiscountPercent': 0, 'distrContractDiscount': 0, 'distrMaxDiscount': 0, 'approvedDiscount': None, 'currency': 'RUB', 'cost': 0, 'costCurrency': 'RUB', 'salesPriceWithTax': 3714.624, 'comments': [{'comment': None, 'color': None}], 'category': None, 'statuses': [{'code': 19, 'description': 'Радиатор'}], 'lineType': 'Material', 'mpg': 'HR', 'areaActivity': None, 'gfu': None, 'materialSubType': 'Ридан', 'availability': {'requestedQty': 2, 'onStockQty': 0, 'transit': None, 'onTransitQty': 0, 'transitDate': None, 'notAvailableQty': 2, 'deliveryWeeks': 0, 'deliveryDays': None, 'deliveryTimeStandard': 'Требуется уточнение сроков'}, 'isSpecialPrice': False, 'isCorrectedQuantity': False, 'allowCreateDueDeliveryTicket': True, 'isZeroPrices': False, 'lockCode': None, 'isManufactureReserved': False, 'equipmentCategoryId': '25f14281-4def-43aa-9021-b9dcfe8ec386', 'equipmentCategory': 'Радиаторы отопления', 'packageSize': 0, 'promoCurrencyValue': 0, 'autoDistrPosDiscount': 0, 'autoClientPosDiscount': 0, 'excludePosition': False, 'sourcePrice': {'value': 1547.7641, 'convertedOfferValue': 1547.7641, 'valueQty': None, 'convertedOfferValueQty': None, 'qty': None, 'currency': 'RUB'}, 'specialPrice': None, 'tenderAmount': None, 'calc': None}], 'orderParty': {'currency': 'RUB', 'customerGroup': None, 'debtorAccount': 'RT25-7705238125-HE', 'deliveryAddress': None, 'deliveryMode': None, 'deliveryPlant': None, 'paymentTerms': 'RU00', 'salesGroup': '', 'salesOffice': '', 'exchangeRate': 98.1888, 'deliveryModeText': None, 'deliveryPlantName': None, 'salesOfficeText': '', 'salesGroupText': '', 'paymentTermsText': '', 'currencyDate': '2025-11-06T00:00:00+03:00', 'exchangeRateType': 'YRU'}, 'deliveryReceivers': [], 'itPtips': None, 'discountTips': None, 'discountTip': None, 'volumeDiscountTips': None, 'kitDiscountTips': None, 'authoPriceResults': None, 'sourceTenderOffer': None}], 'status': 'Warning', 'messages': ['Обращаем Ваше внимание, что позиции: HR00045 являются заказными.\r\n В соответствии с условиями договора поставки изменение или отмена данных позиций после подтверждения заказа Ридан влечет выплату штрафа.']}
Исходное количество из Simulate: 2
Order lines from Simulate: [{'materialCode': 'HR00045', 'quantity': 2, 'lineNumber': 0, 'lineType': 'Material', 'odid': None}]

================================================================================
CREATE OFFER PAYLOAD (что отправляем):
{'orderLines': [{'materialCode': 'HR00045', 'quantity': 2, 'lineNumber': 0, 'lineType': 'Material', 'odid': None}], 'isEndUserPQ': False, 'docType': 'Quotation', 'authorNumber': None, 'currencyDate': None, 'exchangeRateType': None, 'projectDiscountConditions': False, 'debtorAccount': 'RT25-7705238125-HE', 'finalBuyerCDLId': None, 'clientInn': None, 'userComment': 'ТЕСТ флоу методов HR - CreateOffer', 'engineerComment': '', 'currency': 'RUB', 'methodCode': 'ZWEB', 'purchaseDate': '2025-11-06T14:42:47.539896', 'delayedDeliveryDiscountValue': None, 'personId': '0b9a97d3-821d-4f84-b016-d3ab2b433bb7', 'offerId': None, 'passportId': '9abbcb6b-91ac-4d69-bbee-d0d0f583e18d', 'opportunityId': None, 'specTypeId': None, 'specificationId': 'ece5153c-fbbd-4b55-816e-e7dd035364ad', 'salesGroup': 'RU1', 'salesOffice': 'RU01', 'referenceNumber': '', 'paymentTerms': 'RU00', 'isDraft': True, 'purchaseType': None, 'finalBuyerId': '6e9c40d9-59c3-4576-ab38-8b0724fc92fd', 'availableForDistributor': False, 'autoAvailableForDistributor': None, 'payPercentComponentsBTP': None, 'payPercentBeforePlacingIntoProduction': None, 'customerId': None, 'isCLHOffer': False, 'deliveryOptions': {'consigneeCode': None, 'deliveryCost': 0, 'totalDeliveryWeight': 0, 'comment': '', 'consigneeAgreementDelivery': None, 'clientFinalDelivery': None, 'consigneeContacts': None, 'endPoint': 'ToDoor', 'desiredDeliveryDate': '2025-11-07T14:42:47.539896', 'deliverFullSetOnly': False, 'costIncludedInOrder': True, 'consigneeId': '00000000-0000-0000-0000-000000000000', 'deliveryType': 'Pickup'}, 'deliveryOptionsHex': None, 'deliveryOptionsProd': None, 'deliveryOptionsDZRProd': None, 'deliveryNotificationSettings': None, 'projectObject': {'id': '9abbcb6b-91ac-4d69-bbee-d0d0f583e18d', 'name': 'Детский сад на 240 мест в г. Тарко-Сале, мкр.Южный', 'address': 'Ямало-Ненецкий АО, г Тарко-Сале, мкр Южный', 'number': 1178586, 'comment': ' '}, 'setContractDiscounts': False, 'currencySpecialFixation': False, 'extendValidit': 0, 'showPriceWithDiscount': False, 'showDiscount': False, 'finalMarkup': None, 'surchargesPayment': None, 'surchargesConversion': None, 'recommendedDistributors': [], 'source': 'WebClient', 'returnKitDisconts': False, 'distributorContractId': None}
================================================================================

CREATE OFFER RESPONSE
{'objects': [{'lines': [{'remark': None, 'avaliability': [], 'bomSet': None, 'salesPrice': 1547.76, 'cost': None, 'costCurrency': None, 'quantity': 2, 'description': 'Радиатор стальной панельный тип 10 высота 500  длина 400 боковое подключение', 'code': 'HR00045', 'altMaterialCode': None, 'totalWithDiscountSurchargesAndVAT': 3714.624, 'totalWithDiscountAndSurcharges': None, 'totalWithDiscount': None, 'surchargesDelayPercent': None, 'surchargesCurrencyConversionPercent': None, 'discountAmount': None, 'discountPercent': 0, 'weight': None, 'deliveryWeeks': 0, 'calcNumber': None, 'calculationComment': None, 'comment': None, 'isSpecial': 0, 'isProtected': False, 'calcId': None, 'hexIsReady': False, 'clientDiscountPercent': None, 'clientBroughtAmountResult': None, 'itpDiscountPercent': None, 'contractDiscountPercent': None, 'sourceNOrder': 0, 'positionOrder': 0, 'warrantyTotal': None, 'salesPriceWithoutDiscount': 1547.76, 'totalWithoutDiscount': 3095.52, 'subType': 'Import', 'mpg': None, 'prodHierarchy': None, 'category': None, 'taxes': 0, 'abcCategory': None, 'equipmentCategoryId': None, 'equipmentCategory': None, 'surchargePercent': 0}], 'offers': [{'sapReferenceNumber': None, 'paymentTerms': None, 'exchangeRate': 0, 'deliveryPlant': None, 'deliveryMode': None, 'deliveryAddress': None, 'debtorAccount': None, 'currency': 'RUB', 'broughtAmountResult': 3714.624, 'number': 'HR04776937', 'id': '073aff57-bad2-41e9-46c5-08de1d00de21', 'isITPsuccess': None, 'crmUrl': None, 'clientBroughtAmountResult': 0, 'pObjectName': None, 'pObjectNumber': None, 'specificationNumber': None, 'opportunityName': None}, {'sapReferenceNumber': None, 'paymentTerms': None, 'exchangeRate': 0, 'deliveryPlant': None, 'deliveryMode': None, 'deliveryAddress': None, 'debtorAccount': None, 'currency': 'RUB', 'broughtAmountResult': 3714.624, 'number': 'HR04776938', 'id': '0afea3ef-9663-4983-46c6-08de1d00de21', 'isITPsuccess': None, 'crmUrl': None, 'clientBroughtAmountResult': 0, 'pObjectName': None, 'pObjectNumber': None, 'specificationNumber': None, 'opportunityName': None}, {'sapReferenceNumber': None, 'paymentTerms': None, 'exchangeRate': 0, 'deliveryPlant': None, 'deliveryMode': None, 'deliveryAddress': None, 'debtorAccount': None, 'currency': 'RUB', 'broughtAmountResult': 3714.624, 'number': 'HR04776939', 'id': 'b92d38be-830a-47a2-46c7-08de1d00de21', 'isITPsuccess': None, 'crmUrl': None, 'clientBroughtAmountResult': 0, 'pObjectName': None, 'pObjectNumber': None, 'specificationNumber': None, 'opportunityName': None}], 'invoices': None, 'errors': None, 'itPtips': None, 'createdOffers': None}], 'status': 'Ok', 'messages': []}
Created offer_id: 073aff57-bad2-41e9-46c5-08de1d00de21, offer_number: HR04776937
URL FullCommerceNew - https://ruecom-intru-tst.ridancorp.net/dapi/api/CrmCommerce/FullCommerceNew?requestId=073aff57-bad2-41e9-46c5-08de1d00de21
FULL COMMERCE NEW RESPONSE (до UpdateOffer)
{'objects': [{'data': [{'delayedDeliveryDiscountValue': 0.0, 'purchaseType': {'allowPartial': True, 'id': '121b015a-e76d-4688-9bb6-2a56ec6de2ef', 'value': 'Частичная закупка'}, 'paymentSchedule': None, 'completeDeliveryFrom': None, 'paidStorages': None, 'payPercentBeforePlacingIntoProduction': 100, 'filesPO': [], 'filesSA5': [], 'filesSA': [], 'files': [], 'termDate': None, 'sapAuthorPersonNumber': None, 'sapCodeDelivery': None, 'crmPassportNumber': 1178586, 'passportId': '9abbcb6b-91ac-4d69-bbee-d0d0f583e18d', 'passportResponsiblePhone': None, 'passportResponsibleName': 'Юдин Виктор', 'passportResponsibleEmail': 'yudin@ridan.ru', 'passportResponsibleNumber': '00001901', 'endClientOrderInitiator': None, 'specificationTitle': 'Теплоснабж. вент. установок', 'markupPercentResult': None, 'markupResult': 0.0, 'euroRateOffer': 98.1888, 'clientBroughtAmountResult': 3714.624, 'currencyDate': '2025-11-06T00:00:00', 'syncDate': None, 'currency': 'RUB', 'vaTcoef': 1.2, 'vaTperc': 20, 'isEndUserPQ': False, 'vaTresult': 619.104, 'totalVat': 3714.624, 'total': 3095.52, 'validDate': '2025-11-20T14:42:48.1', 'validDays': 14, 'totalDistrDiscountPrice': 3714.624, 'salesPrice': 3095.52, 'objectCity': 'ЯНАО', 'objectAddress': None, 'objectNumber': 1178586, 'objectName': '"Детский сад на 240 мест в г. Тарко-Сале, мкр.Южный"', 'orders': None, 'debtorAccount': 'RT25-7705238125-HE', 'payerDisplay': 'фирма "ВОДОКОМФОРТ" (Офис Москва)', 'payerId': 'acb8f425-c3b6-4b38-9f34-1e7fbfd53fa9', 'paymentTerm': {'code': 'RU00', 'text': 'Предоплата', 'creditDays': 0, 'prepayPercent': 100}, 'endUserClientPerson': None, 'endUserClientId': None, 'endUserClient': 'ООО "ТЕХНОГРУПП"', 'createDate': '2025-11-06T14:42:48.103', 'commerceNumber': 'HR04776937', 'deliveryShortInfo': 'Самовывоз', 'deliveryCondition': None, 'statusDisplay': 'Черновик', 'status': '5d6f1a5d-3254-44e5-97d7-c4d20f440b61', 'surchargesPayment': 0.0, 'surchargesConvertation': 0.0, 'partialPurchase': True, 'crmCommerceId': '073aff57-bad2-41e9-46c5-08de1d00de21', 'salesOffice': 'Омск', 'finalClientInn': '6450092725', 'payerInn': '7705238125', 'deliveryOptions': {'consigneeCode': None, 'condition': None, 'mode': None, 'deliveryType': 'Pickup', 'materialType': 'regularCodesMSK', 'deliveryCost': 0, 'deliveryCostInOrderCurrency': 0, 'totalDeliveryWeight': 0, 'comment': '', 'consigneeAgreementDelivery': None, 'clientFinalDelivery': None, 'consigneeContacts': None, 'endPoint': 'ToDoor', 'desiredDeliveryDate': '2025-11-07T14:42:47.539896', 'deliverFullSetOnly': False, 'costIncludedInOrder': True, 'consigneeId': '00000000-0000-0000-0000-000000000000'}, 'deliveryOptionsHex': None, 'deliveryOptionsProd': None, 'deliveryOptionsDZRProd': None, 'availableForDistributor': False, 'isOrder': False, 'isValid': True, 'isITPsuccess': False, 'creatorUserId': '342b3e2e-a022-4794-9d49-c45999ae434a', 'creatorPersonId': '0b9a97d3-821d-4f84-b016-d3ab2b433bb7', 'creatorDisplay': 'Иванова Наталья Сергеевна', 'orderNumber': None, 'sapReferenceNumber': None, 'approvementDeclined': False, 'distrApprovement': None, 'endClientOrderCreator': {'personId': '0b9a97d3-821d-4f84-b016-d3ab2b433bb7', 'email': 'ivanova@vodokomfort.ru', 'phone': None, 'name': 'Водокомфорт ООО (офис Санкт-Петербург)'}, 'autoDistrDiscount': None, 'autoFromEngSpec': False, 'finalBayerId': '6e9c40d9-59c3-4576-ab38-8b0724fc92fd', 'factPaymentPercent': 0.0, 'extendedWarranty': {'type': 'None', 'paymentType': 'None', 'invoiceType': 'None'}, 'isPinnedFinalBuyer': False, 'reservationEnd': None, 'autoClientDiscount': None, 'comments': [{'comment': 'ТЕСТ флоу методов HR - CreateOffer', 'author': 'Иванова Н. С.', 'createDate': '2025-11-06T14:42:48.103'}, {'comment': ' ', 'author': 'Иванова Н. С.', 'createDate': '2025-11-06T14:42:48.103'}], 'endUserPQStatusId': None, 'endUserPQDescription': None, 'confirmTimeByDistr': None, 'responseTimeClient': None, 'opportunityId': 'f2794130-506e-448a-bc25-5a9f13f2603f', 'finalBuyerCDLId': None, 'offerType': 'HR', 'offerFlags': [], 'showPriceWithDiscount': False, 'showDiscount': True, 'source': 'WebClient', 'oneCCurrentStatus': None, 'clientPersonId': None, 'deliveryTerms': None, 'deliveryTermsPTO': None}], 'details': [{'fromMoscow': False, 'weight': 0, 'packageSize': -1, 'ptoReadyForShipmentValue': None, 'islBox': False, 'isBTP': False, 'isPTO': False, 'isTDU': False, 'lineType': 'Material', 'markupPercentResult': 0.0, 'markupResult': None, 'priceGroup': 'HR', 'totalVAT': 3714.624, 'total': 3095.52, 'vaTresult': 619.104, 'retailPriceResultNoNDS': 3095.52, 'retailPriceResult': 3714.62, 'discount': 0.0, 'currency': 'RUB', 'salesPrice': 1547.76, 'clientSalesPrice': 1547.76, 'text': 'Радиатор стальной панельный тип 10 высота 500  длина 400 боковое подключение', 'code': 'HR00045', 'materialCode': 'HR00045', 'qty': 2.0, 'id': 'c6423767-7214-4e60-8c4a-a7d3398bfa88', 'item': 1, 'hexNumber': None, 'btpNumber': None, 'warrantyTotal': 0.0, 'clientDiscountPercent': None, 'clientBroughtAmountResult': 3714.624, 'availableForOrder': 2.0, 'deliveredCount': 0, 'stockCount': 0, 'packagedCount': 0, 'notPayedCount': 0, 'transit': None, 'isCanceled': False, 'canceledQuantity': 0, 'cancelReason': None, 'isSpecialPrice': False, 'bomSet': None, 'organization': {'contractorId': '85762916-f70a-4675-8b61-6e1536add151', 'inn': '3328495208', 'contractorName': 'ООО "ВАЛФ-РУС"', 'approvers': []}, 'shippedAt': None, 'applyedPromo': None, 'invoiceNumber': None, 'invoiceDate': None, 'warehouse': None, 'isExclusiveBTP': False}], 'permissions': {'edit': False, 'moveToDraft': False, 'delete': False, 'addComment': False, 'addFile': False, 'getFile': False}}], 'status': 'Ok', 'messages': []}
Найдено 1 позиций в details
Mapping: HR00045 → c6423767-7214-4e60-8c4a-a7d3398bfa88
Contractor: HR00045 → 85762916-f70a-4675-8b61-6e1536add151
✓ Updated ODID for HR00045: c6423767-7214-4e60-8c4a-a7d3398bfa88
✓ Updated contractorId for HR00045: 85762916-f70a-4675-8b61-6e1536add151
Updated order lines with ODID: [{'materialCode': 'HR00045', 'quantity': 2, 'lineNumber': 0, 'lineType': 'Material', 'odid': 'c6423767-7214-4e60-8c4a-a7d3398bfa88', 'contractorId': '85762916-f70a-4675-8b61-6e1536add151'}]

  Ожидаем lineType: 'Material'
  Получили lineType: 'Material'
  lineType корректен: 'Material'

================================================================================
ПРОВЕРКА СТАНДАРТНЫХ ПОЛЕЙ ПОСЛЕ CreateOffer → FullCommerceNew
================================================================================

 materialCode: ожидаем 'HR00045', получили 'HR00045'
 quantity: ожидаем 2, получили 2.0
 currency: ожидаем 'RUB', получили 'RUB'
 debtorAccount: ожидаем 'RT25-7705238125-HE', получили 'RT25-7705238125-HE'
 personId: ожидаем '0b9a97d3-821d-4f84-b016-d3ab2b433bb7', получили '0b9a97d3-821d-4f84-b016-d3ab2b433bb7'

 Все стандартные поля корректны!
================================================================================

Original Seller ID: 85762916-f70a-4675-8b61-6e1536add151
Original Contractor Name: ООО "ВАЛФ-РУС"
OpportunityId из FullCommerceNew: f2794130-506e-448a-bc25-5a9f13f2603f
Добавили sellerId в UpdateOffer: 85762916-f70a-4675-8b61-6e1536add151

================================================================================
UPDATE OFFER PAYLOAD (что отправляем):
{'orderLines': [{'materialCode': 'HR00045', 'quantity': 3, 'lineNumber': 0, 'lineType': 'Material', 'odid': 'c6423767-7214-4e60-8c4a-a7d3398bfa88', 'contractorId': '85762916-f70a-4675-8b61-6e1536add151', 'discountPercent': 10, 'endClientDiscountPercent': 10}], 'isEndUserPQ': False, 'docType': 'Quotation', 'authorNumber': None, 'currencyDate': None, 'exchangeRateType': None, 'projectDiscountConditions': False, 'debtorAccount': 'RT25-7705238125-HE', 'finalBuyerCDLId': None, 'clientInn': None, 'userComment': 'ТЕСТ флоу методов HR - UpdateOffer', 'engineerComment': '', 'currency': 'RUB', 'methodCode': 'ZWEB', 'purchaseDate': '2025-11-06T14:42:47.539896', 'delayedDeliveryDiscountValue': None, 'personId': '0b9a97d3-821d-4f84-b016-d3ab2b433bb7', 'offerId': '073aff57-bad2-41e9-46c5-08de1d00de21', 'passportId': '9abbcb6b-91ac-4d69-bbee-d0d0f583e18d', 'opportunityId': 'f2794130-506e-448a-bc25-5a9f13f2603f', 'specTypeId': None, 'specificationId': 'ece5153c-fbbd-4b55-816e-e7dd035364ad', 'salesGroup': 'RU1', 'salesOffice': 'RU01', 'referenceNumber': '', 'paymentTerms': 'RU00', 'isDraft': False, 'purchaseType': None, 'finalBuyerId': '6e9c40d9-59c3-4576-ab38-8b0724fc92fd', 'availableForDistributor': False, 'autoAvailableForDistributor': None, 'payPercentComponentsBTP': None, 'payPercentBeforePlacingIntoProduction': None, 'customerId': None, 'isCLHOffer': False, 'deliveryOptions': {'consigneeCode': None, 'deliveryCost': 0, 'totalDeliveryWeight': 0, 'comment': '', 'consigneeAgreementDelivery': None, 'clientFinalDelivery': None, 'consigneeContacts': None, 'endPoint': 'ToDoor', 'desiredDeliveryDate': '2025-11-07T14:42:47.539896', 'deliverFullSetOnly': False, 'costIncludedInOrder': True, 'consigneeId': '00000000-0000-0000-0000-000000000000', 'deliveryType': 'Pickup'}, 'deliveryOptionsHex': None, 'deliveryOptionsProd': None, 'deliveryOptionsDZRProd': None, 'deliveryNotificationSettings': None, 'projectObject': {'id': '9abbcb6b-91ac-4d69-bbee-d0d0f583e18d', 'name': 'Детский сад на 240 мест в г. Тарко-Сале, мкр.Южный', 'address': 'Ямало-Ненецкий АО, г Тарко-Сале, мкр Южный', 'number': 1178586, 'comment': ' '}, 'setContractDiscounts': False, 'currencySpecialFixation': False, 'extendValidit': 0, 'showPriceWithDiscount': False, 'showDiscount': False, 'finalMarkup': None, 'surchargesPayment': None, 'surchargesConversion': None, 'recommendedDistributors': [], 'source': 'WebClient', 'returnKitDisconts': False, 'distributorContractId': None, 'sellerId': '85762916-f70a-4675-8b61-6e1536add151'}
================================================================================

UPDATE OFFER RESPONSE
{'objects': [{'status': True}], 'status': 'Ok', 'messages': []}
✓ UpdateOffer успешно выполнен!
URL FullCommerceNew - https://ruecom-intru-tst.ridancorp.net/dapi/api/CrmCommerce/FullCommerceNew?requestId=073aff57-bad2-41e9-46c5-08de1d00de21
FULL COMMERCE NEW RESPONSE (после UpdateOffer)
{'objects': [{'data': [{'delayedDeliveryDiscountValue': 0.0, 'purchaseType': {'allowPartial': True, 'id': '121b015a-e76d-4688-9bb6-2a56ec6de2ef', 'value': 'Частичная закупка'}, 'paymentSchedule': None, 'completeDeliveryFrom': None, 'paidStorages': None, 'payPercentBeforePlacingIntoProduction': 100, 'filesPO': [], 'filesSA5': [], 'filesSA': [], 'files': [], 'termDate': None, 'sapAuthorPersonNumber': None, 'sapCodeDelivery': None, 'crmPassportNumber': 1178586, 'passportId': '9abbcb6b-91ac-4d69-bbee-d0d0f583e18d', 'passportResponsiblePhone': None, 'passportResponsibleName': 'Юдин Виктор', 'passportResponsibleEmail': 'yudin@ridan.ru', 'passportResponsibleNumber': '00001901', 'endClientOrderInitiator': None, 'specificationTitle': 'Теплоснабж. вент. установок', 'markupPercentResult': None, 'markupResult': 0.0, 'euroRateOffer': 98.1888, 'clientBroughtAmountResult': 5014.728, 'currencyDate': '2025-11-06T00:00:00', 'syncDate': None, 'currency': 'RUB', 'vaTcoef': 1.2, 'vaTperc': 20, 'isEndUserPQ': False, 'vaTresult': 835.7904, 'totalVat': 5014.7424, 'total': 4178.952, 'validDate': '2025-11-20T14:42:48.1', 'validDays': 14, 'totalDistrDiscountPrice': 5014.7424, 'salesPrice': 4643.28, 'objectCity': 'ЯНАО', 'objectAddress': None, 'objectNumber': 1178586, 'objectName': '"Детский сад на 240 мест в г. Тарко-Сале, мкр.Южный"', 'orders': None, 'debtorAccount': 'RT25-7705238125-HE', 'payerDisplay': 'фирма "ВОДОКОМФОРТ" (Офис Москва)', 'payerId': 'acb8f425-c3b6-4b38-9f34-1e7fbfd53fa9', 'paymentTerm': {'code': 'RU00', 'text': 'Предоплата', 'creditDays': 0, 'prepayPercent': 100}, 'endUserClientPerson': None, 'endUserClientId': None, 'endUserClient': 'ООО "ТЕХНОГРУПП"', 'createDate': '2025-11-06T14:42:48.103', 'commerceNumber': 'HR04776937', 'deliveryShortInfo': 'Самовывоз', 'deliveryCondition': None, 'statusDisplay': 'Согласование', 'status': 'a4f61a50-c5b3-475b-bc96-26045438f547', 'surchargesPayment': 0.0, 'surchargesConvertation': 0.0, 'partialPurchase': True, 'crmCommerceId': '073aff57-bad2-41e9-46c5-08de1d00de21', 'salesOffice': 'Омск', 'finalClientInn': '6450092725', 'payerInn': '7705238125', 'deliveryOptions': {'consigneeCode': None, 'condition': None, 'mode': None, 'deliveryType': 'Pickup', 'materialType': 'regularCodesMSK', 'deliveryCost': 0, 'deliveryCostInOrderCurrency': 0, 'totalDeliveryWeight': 0, 'comment': '', 'consigneeAgreementDelivery': None, 'clientFinalDelivery': None, 'consigneeContacts': None, 'endPoint': 'ToDoor', 'desiredDeliveryDate': '2025-11-07T14:42:47.539896', 'deliverFullSetOnly': False, 'costIncludedInOrder': True, 'consigneeId': '00000000-0000-0000-0000-000000000000'}, 'deliveryOptionsHex': None, 'deliveryOptionsProd': None, 'deliveryOptionsDZRProd': None, 'availableForDistributor': False, 'isOrder': False, 'isValid': True, 'isITPsuccess': False, 'creatorUserId': '342b3e2e-a022-4794-9d49-c45999ae434a', 'creatorPersonId': '0b9a97d3-821d-4f84-b016-d3ab2b433bb7', 'creatorDisplay': 'Иванова Наталья Сергеевна', 'orderNumber': None, 'sapReferenceNumber': None, 'approvementDeclined': False, 'distrApprovement': None, 'endClientOrderCreator': {'personId': '0b9a97d3-821d-4f84-b016-d3ab2b433bb7', 'email': 'ivanova@vodokomfort.ru', 'phone': None, 'name': 'Водокомфорт ООО (офис Санкт-Петербург)'}, 'autoDistrDiscount': None, 'autoFromEngSpec': False, 'finalBayerId': '6e9c40d9-59c3-4576-ab38-8b0724fc92fd', 'factPaymentPercent': 0.0, 'extendedWarranty': {'type': 'None', 'paymentType': 'None', 'invoiceType': 'None'}, 'isPinnedFinalBuyer': False, 'reservationEnd': None, 'autoClientDiscount': None, 'comments': [{'comment': 'ТЕСТ флоу методов HR - CreateOffer', 'author': 'Иванова Н. С.', 'createDate': '2025-11-06T14:42:48.103'}, {'comment': ' ', 'author': 'Иванова Н. С.', 'createDate': '2025-11-06T14:42:48.103'}, {'comment': 'ТЕСТ флоу методов HR - UpdateOffer', 'author': 'Иванова Н. С.', 'createDate': '2025-11-06T14:42:50.64'}, {'comment': ' ', 'author': 'Иванова Н. С.', 'createDate': '2025-11-06T14:42:50.64'}], 'endUserPQStatusId': None, 'endUserPQDescription': None, 'confirmTimeByDistr': None, 'responseTimeClient': None, 'opportunityId': 'f2794130-506e-448a-bc25-5a9f13f2603f', 'finalBuyerCDLId': None, 'offerType': 'HR', 'offerFlags': [], 'showPriceWithDiscount': False, 'showDiscount': True, 'source': 'WebClient', 'oneCCurrentStatus': None, 'clientPersonId': None, 'deliveryTerms': None, 'deliveryTermsPTO': None}], 'details': [{'fromMoscow': False, 'weight': 0, 'packageSize': -1, 'ptoReadyForShipmentValue': None, 'islBox': False, 'isBTP': False, 'isPTO': False, 'isTDU': False, 'lineType': 'Material', 'markupPercentResult': 0.0, 'markupResult': None, 'priceGroup': 'HR', 'totalVAT': 5014.7424, 'total': 4178.952, 'vaTresult': 835.7904, 'retailPriceResultNoNDS': 4643.28, 'retailPriceResult': 5571.94, 'discount': 10.0, 'currency': 'RUB', 'salesPrice': 1547.76, 'clientSalesPrice': 1547.76, 'text': 'Радиатор стальной панельный тип 10 высота 500  длина 400 боковое подключение', 'code': 'HR00045', 'materialCode': 'HR00045', 'qty': 3.0, 'id': 'c6423767-7214-4e60-8c4a-a7d3398bfa88', 'item': 1, 'hexNumber': None, 'btpNumber': None, 'warrantyTotal': 0.0, 'clientDiscountPercent': 10.0, 'clientBroughtAmountResult': 5014.728, 'availableForOrder': 3.0, 'deliveredCount': 0, 'stockCount': 0, 'packagedCount': 0, 'notPayedCount': 0, 'transit': None, 'isCanceled': False, 'canceledQuantity': 0, 'cancelReason': None, 'isSpecialPrice': False, 'bomSet': None, 'organization': {'contractorId': '85762916-f70a-4675-8b61-6e1536add151', 'inn': '3328495208', 'contractorName': 'ООО "ВАЛФ-РУС"', 'approvers': [{'personId': '393ce1e9-40f7-4f00-ba48-97621e5ab884', 'email': 'kuzmin_an@valfex.ru', 'phone': '+7 (915) 764-62-74', 'name': 'Кузьмин Андрей Николаевич'}]}, 'shippedAt': None, 'applyedPromo': None, 'invoiceNumber': None, 'invoiceDate': None, 'warehouse': None, 'isExclusiveBTP': False}], 'permissions': {'edit': False, 'moveToDraft': False, 'delete': False, 'addComment': False, 'addFile': False, 'getFile': False}}], 'status': 'Ok', 'messages': []}

Проверка количества для HR00045:
  Ожидаем: 3
  Получили: 3.0
✓ Количество корректно!

Проверка скидки для HR00045:
  Ожидаем: 10%
  Получили: 10.0%
✓ Скидка корректна!

================================================================================
ПРОВЕРКА ПОЛЕЙ ПОСЛЕ UpdateOffer → FullCommerceNew
================================================================================

 materialCode: ожидаем 'HR00045', получили 'HR00045'
 quantity: ожидаем 3, получили 3.0
 discount: ожидаем 10%, получили 10.0%
 currency: ожидаем 'RUB', получили 'RUB'
 debtorAccount: ожидаем 'RT25-7705238125-HE', получили 'RT25-7705238125-HE'
 personId: ожидаем '0b9a97d3-821d-4f84-b016-d3ab2b433bb7', получили '0b9a97d3-821d-4f84-b016-d3ab2b433bb7'
 lineType: ожидаем 'Material', получили 'Material'

 Все поля после UpdateOffer корректны!
================================================================================

Продавец после UpdateOffer: ООО "ВАЛФ-РУС" (85762916-f70a-4675-8b61-6e1536add151)
✓ Продавец остался прежним: ООО "ВАЛФ-РУС"
✓ Все изменения успешно применились!

Статус КП после UpdateOffer: Согласование
Order/Create НЕ выполняется - КП остается в статусе согласования

Тест успешно выполнен! (без Order/Create)
PASSED

======================= 5 passed, 6 warnings in 32.80s ========================

Process finished with exit code 0
